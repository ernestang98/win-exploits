# Chrome Architecture

- V8: JavaScript Engine

- Blink: Renderer Engine

- Mojo: IPC between Browser and Renderer

- Renderer Sandbox: 1 tab = 1 renderer = 1 process (low privileges)

- Isolate: a running instance of a V8 engine (like a thread to a process?). 1 thread is allocated 1 isolate object

- Context: global scope for variables, allows differentiating of variables belonging to 1 window from another

# Blink

- Renderer Engine, forked from WebKit

- [Uses various allocators](https://chromium.googlesource.com/chromium/src/+/0e94f26e8/third_party/WebKit/Source/wtf/Allocator.md)

# V8

### JavaScript compilation in V8

How does javascript work in V8?

```
code -> token -> ast -> bytecode -> optimized code
``` 

- V8 handles parsing code into AST

- Ignition handles interpreting AST into Bytecode

- Sparkplug compiles Bytecode into non-optimized native code

- [NEW] Maglev is a mid-tier optimizer which optimizes non-optimized native code to semi-optimized maglev nativ code

- Turbofan optimised non-optimized native code

Some interesting stuff:

- [Understanding V8's Bytecode](https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775)

- [V8 Binding Design](https://chromium.googlesource.com/chromium/src/+/master/third_party/blink/renderer/bindings/core/v8/V8BindingDesign.md)

- [V8 Inline Caching](https://javascript.plainenglish.io/v8-engine-and-inline-caching-in-javascript-fef80054a551)

### V8 Object Internals

Javascript types are dynamic, but how does this shit work if javascript is based on c++ which is statically typed? - Map a.k.a. Hidden Class (Shape)

Most objects are structured as so:

```
--------------
|     Map    |
--------------
| Properties |
--------------
|  Elements  |
--------------
```

Properties points to the values in the key-value pairs of object while Elements points to the values in an array/in an object (numbered properties) (both technically can function as backing stores). There are 2 kinds of properties:

1. [Fast Properties](https://v8.dev/blog/fast-properties)

2. Slow/Dictionary Properties

### Pointer Tagging

- In v8, values represented as objects and allocated on the heap

- If we need to keep allocating on heap everytime we manipulate/create/delete object, that sucks

- Instead, store some of the values inline so that we dont have to keep using the heap

- Then how to differentiate object pointer from inline value? Pointer Tagging

### Pointer Compression

- Use 4 bytes instead of 8 bytes 

- MSB stored in r13

- Serve as some form of sandbox 

### TheHole

- V8 object which is essentially used to indicate that a certain variable/value/property is "empty"

- TheHole is an oddball type (same as undefined, null etc.). Look [here](https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/oddball.h;l=6;drc=7a393a25bc7b2cd934a433fb02255e993e2fd78a;bpv=1;bpt=1?q=describes%20oddball&sq=&ss=chromium%2Fchromium%2Fsrc) for what is an oddball type.

- In the past, you can exploit TheHole using Maps because of the way Maps mark their property as empty when you call delete() with the value of TheHole. Refer to [StarLabs](https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/) analysis of how TheHole was leaked via JSON.stringify and subsequently exploited via Maps(). Another example can be found [here](https://issues.chromium.org/issues/40061500) where the exploit writer also leaked TheHole via CVE-2022-4174 and also used Map() to obtain RCE. 

- Many CVEs also result in TheHole being leaked such as [CVE-2022-1364](https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html) and [CVE-2022-1310](https://issues.chromium.org/issues/40059133)

- It is hard to completely remove TheHole due to its importance to the Chromium source code, BUT we can patch the exploitation technique of using Map() with TheHole which is what chromium developers did in this [commit](https://github.com/v8/v8/commit/66c8de2cdac10cad9e622ecededda411b44ac5b3)

- Unfortunatelt/Forunately, mistymntncop discovered a way to exploit TheHole, using TurboFan and introducting Typer bugs which removes certain validation checks during optimization leading to Type Confusion, covered extensively by [cwresearchlab](https://cwresearchlab.co.kr/entry/CVE-2023-2033-JIT-optimisation-issue) and [theori](https://blog.theori.io/chaining-n-days-to-compromise-all-part-1-chrome-renderer-rce-1afccf56721b). Original PoC can be found [here](https://github.com/mistymntncop/CVE-2023-3079)

### TurboFan resources

[Sea of nodes](https://darksi.de/d.sea-of-nodes/)

[TurboFa Design](https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/htmlpresent)

[Speculative Optimization](https://ponyfoo.com/articles/an-introduction-to-speculative-optimization-in-v8)

### General Guides

[Mathias Bynens - V8 internals for JavaScript developers](https://www.youtube.com/watch?v=m9cTaYI95Zc)

[Github Gist on various JavaScript data structures in V8](https://github.com/push0ebp/v8-starter-guide)

[Pointer Compression](https://v8.dev/blog/pointer-compression)

[Brief overview of V8 things (e.g. IC, GC, Classes, TurboFan)](https://blog.appsignal.com/2020/07/01/a-deep-dive-into-v8.html)

[JavaScript Internals (4 parts series)](https://dev.to/amitkhonde/javascript-internals-arrays-1jek)

[Array Internals](https://itnext.io/v8-deep-dives-understanding-array-internals-5b17d7a28ecc)

# Others

### Debugging Things

```
d8.exe --allow-natives-syntax --trace-opt
bp v8!v8::internal::Runtime_DebugPrint
"C:\Users\kali\AppData\Local\Google\Chrome\Application\chrome.exe" --no-sandbox --js-flags="--allow-natives-syntax" --enable-logging --v=1
"C:\Program Files\Google\Chrome\Application\chrome.exe" --no-sandbox --js-flags="--allow-natives-syntax" --enable-logging --v=1
```

- There are other hacky ways of debugging Chrome/V8. Take some inspiration from [this](https://www.cnblogs.com/Ox9A82/p/5777235.html) old but gold technique used in IE

### Useful Utilities

[hex to float #1](https://resource.heltec.cn/utils/hf)

[hex to float #2](https://gregstoll.com/~gregstoll/floattohex/)

[gdb macro job](https://stackoverflow.com/questions/58433681/i-want-to-use-job-command-in-v8-release-so-how-can-i-do-it-or-just-by-pass-th)
