# How to build V8

### Windows

1. Download depot tools

2. Add depot tools path to the FRONT of your PATH environmental variable

3. Create DEPOT_TOOLS_WIN_TOOLCHAIN environmental variable and set it to 0

4. Create vs????_install variable and set it to the installation path to your MSVC

    - MSVC 2019 + vs2017_install settings which was used in [Jack Halon's blog](https://jhalon.github.io/chrome-browser-exploitation-3/) allowed me to smoothly build d8.exes until 12.2.XXXX (may work for more versions but never tried, also you may have to uninstall/install older/newer Windows SDK versions). Does NOT work for latest d8 version which is 12.7.XXXX as of at this point in time (need to use MSVC 2022).

    - MSVC 2022 may not work for older builds of d8.exe but it certainly works for newer ones (it can be used to build 11.4.XXXX so with both MSVC 2022 and MSVC 2017, you should be able to build most V8s from 2018 to now (2024))

    - You may also need to change the version of depot tools itself based on the version of d8 you are building

        ```
        COMMIT_DATE=$(git show -s --format=%cd --date=format:'%Y-%m-%d')
        git checkout $(git rev-list -n 1 --before="$COMMIT_DATE" master)
        ```

5. Install the appropriate version of Windows SDK. Below is an example of logs which will indicate that you don't have the correct version of Windows SDK installed. Download them from [microsoft](https://developer.microsoft.com/en-us/windows/downloads/sdk-archive/) other various sources (e.g. Google, Archive.org).

    ```
    Traceback (most recent call last):
    File "C:\chromium\src\build\vs_toolchain.py", line 573, in <module>
        sys.exit(main())
                ^^^^^^
    File "C:\chromium\src\build\vs_toolchain.py", line 569, in main
        return commands[sys.argv[1]](*sys.argv[2:])
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "C:\chromium\src\build\vs_toolchain.py", line 400, in CopyDlls
        _CopyDebugger(target_dir, target_cpu)
    File "C:\chromium\src\build\vs_toolchain.py", line 433, in _CopyDebugger
        raise Exception('%s not found in "%s"\r\nYou must install'
    Exception: api-ms-win-downlevel-kernel32-l2-1-0.dll not found in "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\api-ms-win-downlevel-kernel32-l2-1-0.dll"
    You must installWindows 10 SDK version 10.0.19041.0 including the "Debugging Tools for Windows" feature.
    ```

6. Fix any miscellaneous errors (such as incompatible python3 versions). Google/ChatGPT before sequentially resolving them

7. Run `gclient` (make sure no errors)

8. Run `mkdir v8 ; cd v8 ; fetch v8`

9. Run `cd v8`  (your path should be something like C:\v8\v8)

10. Run `gclient sync -D`

11. Run `gn gen --ide=vs out\x64.debug` / `gn gen out\x64.debug`

12. Run x64 Native Tools Command Prompt and execute `cd C:\v8\v8\out\x64.debug` 

13. Run `msbuild all.sln` 

    - Run `ninja -C out\x64.debug d8` or `autoninja -C out\x64.debug d8` to just build d8

    - If you encounter some ninja.exe cannot be found error, a hackish way I found to "help" the command prompt find the ninja.exe file is to just run the msbuild command then kill it (cause msbuild uses ninja), then run the ninja/autoninja command as per normal

14. Edit args.gn appropriately and accordingly

15. You may encounter the following error for vs2017 setup where `vs2017_install` is set to `C:\Program Files (x86)\Microsoft Visual Studio 14.0\`:

    ```
    Build:
    call ninja.exe -C C:\v8\v8\out\x64.debug\  cppgc.dll.lib
    ninja: Entering directory `C:\v8\v8\out\x64.debug\'
    [1/696] ACTION //src/inspector:protocol_generated_sources(//build/toolchain/win:win_clang_x64)
    FAILED: gen/src/inspector/protocol/Forward.h gen/src/inspector/protocol/Protocol.cpp gen/src/inspector/protocol/Proto
    col.h gen/src/inspector/protocol/Console.cpp gen/src/inspector/protocol/Console.h gen/src/inspector/protocol/Debugger
    .cpp gen/src/inspector/protocol/Debugger.h gen/src/inspector/protocol/HeapProfiler.cpp gen/src/inspector/protocol/Hea
    pProfiler.h gen/src/inspector/protocol/Profiler.cpp gen/src/inspector/protocol/Profiler.h gen/src/inspector/protocol/
    Runtime.cpp gen/src/inspector/protocol/Runtime.h gen/src/inspector/protocol/Schema.cpp gen/src/inspector/protocol/Sch
    ema.h gen/include/inspector/Debugger.h gen/include/inspector/Runtime.h gen/include/inspector/Schema.h
    C:/Users/asdku/AppData/Local/Programs/Python/Python312/python.exe ../../third_party/inspector_protocol/code_generator
    .py --jinja_dir ../../third_party/ --output_base gen/src/inspector --config ../../src/inspector/inspector_protocol_co
    nfig.json --inspector_protocol_dir ///third_party/inspector_protocol
    Traceback (most recent call last):
        File "C:\v8\v8\third_party\inspector_protocol\code_generator.py", line 702, in <module>
        main()
        File "C:\v8\v8\third_party\inspector_protocol\code_generator.py", line 584, in main
        jinja_env = initialize_jinja_env(jinja_dir, config.protocol.output, config)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        File "C:\v8\v8\third_party\inspector_protocol\code_generator.py", line 190, in initialize_jinja_env
        import jinja2
        File "C:\v8\v8\third_party\jinja2\__init__.py", line 33, in <module>
        from jinja2.environment import Environment, Template
        File "C:\v8\v8\third_party\jinja2\environment.py", line 16, in <module>
        from jinja2.defaults import BLOCK_START_STRING, \
        File "C:\v8\v8\third_party\jinja2\defaults.py", line 32, in <module>
        from jinja2.tests import TESTS as DEFAULT_TESTS
        File "C:\v8\v8\third_party\jinja2\tests.py", line 13, in <module>
        from collections import Mapping
    ImportError: cannot import name 'Mapping' from 'collections' (C:\Users\asdku\AppData\Local\Programs\Python\Python312\
    Lib\collections\__init__.py)
    ninja: build stopped: subcommand failed.
    ```

    - The fix is to change all instances of `from collections import Mapping` to:

        ```
        try:
            from collections.abc import Mapping
        except ImportError:
            from collections import Mapping
        ```


### Linux & Android (On Ubuntu 22.04)

1. Run `git clone depot_tools` (e.g. /home/user/depot_tools)

2. Add path to depot_tools (e.g. `PATH=/home/user/depot_tools:$PATH`)

3. Run `mkdir v8 && cd v8 && fetch v8`

4. Run `echo "target_os = ['android', 'unix']" >> .gclient`

5. Run `./build/install-build-deps.sh --android` and `./build/install-build-deps.sh `

6. Run `gclient sync`

7. Checkout to the particular version of V8 you desire and run gclient sync again

8. Run `./tools/dev/gm.py x64.release` or `gn gen out/x64.release`

9. Edits args.gn appropriately and accordingly

10. Lowest possible build for me is 11.0.1 using 776298987617eb544c5ef03bc8e67c7f2d0fdcbc version of depot_tools as of 9th August 2024, 20:23:54. If you want to build older versions of V8, I suggest to try on a older version of Ubuntu and also adjust the version of depot_tools accordingly.

### Linux & Android (On Ubuntu 18.04)

1. Most of the steps here follows the instructions by [chromium documentation](https://chromium.googlesource.com/chromium/src.git/+/HEAD/docs/building_old_revisions.md) and some steps elicited in this stackoverflow [thread](https://stackoverflow.com/questions/47185985/how-to-build-a-specific-version-of-chromium)

2. Run `git clone depot_tools` (e.g. /home/user/depot_tools)

3. Add path to depot_tools (e.g. `PATH=/home/user/depot_tools:$PATH`)

4. Run `mkdir v8 && cd v8 && fetch v8`

5. Run `echo "target_os = ['android', 'unix']" >> .gclient`

6. A nice write-up by [ir0nstone](https://ir0nstone.gitbook.io/notes/binexp/browser-exploitation/ctf-2019-oob-v8) tells us that we need to additionally install the following dependencies: curl, wget, ninja-build and python3.8

   - Make sure to change the symbolic links between python3.8 and python3.6 accordingly if not you will encounter the following [error](https://stackoverflow.com/questions/56218562/how-to-fix-modulenotfounderror-no-module-named-apt-pkg)

8. Run `./build/install-build-deps.sh --android` and `./build/install-build-deps.sh `

9. A nice hint by this [gist](https://gist.github.com/qrealka/0aa39d850310d02ced2dd71a95ae6b0f) tells us that after we revert depot_tools to an older commit, to prevent it from syncing back to the current version, we can just rename the `.git/` folder as something else

10. Run `gclient sync`

# How to build chrome 

### Windows/Linux/Android

1. Environment setup similar to building v8 (as for steps just refer to Chromium documentation)

2. Do NOT run `fetch chromium` (you will run into some network issues cause chromium has far too many commits...), instead run the following commands:

    ```
    fetch --nohistory chromium 
    git fetch --tags
    ```

    - If you want to optimize it even further, follow this stackoverflow [thread](https://stackoverflow.com/questions/45338495/fetch-a-single-tag-from-remote-repository) to just fetch and checkout a specific tag

3. Depot_tools commit `62fc3a1d244368a430ffd7a6b55377a6dfd5e348` will allow you to build from Chrome M106 to M128 which is the latest release as of now (tested).

4. If you encounter the below error, it means that either you are building in a VM and your VM does not have enough memory/processors or you are building on your host and your computer sucks. If it is the former, allocate more resources/build on host. If it is the latter, get richer and buy a new computer.

    ![](./screenshots/others/fetch.png)

# References

- [args.gn](https://www.chromium.org/developers/gn-build-configuration/)

- [cross compiling arm](https://v8.dev/docs/cross-compile-arm)

- [building v8](https://v8.dev/docs/build)

- [chromium * build instructions](https://chromium.googlesource.com/chromium/src/+/main/docs/*_build_instructions.md)

- [Random script which can be useful](https://gist.github.com/revmischa/cd299db577af73965ef96ee6dbd1deca)

- [Another random script which can be useful](https://github.com/Ravbug/chromiumbuild/blob/master/chromiumbuild_win.bat)

- [Another another random script which can be useful](https://github.com/porkycode/Chromium-Windows-Build)

- [Nice guy that builds and releases chromium](https://github.com/Hibbiki/chromium-win64)

- [MSVC 2013 LMAO](https://gist.github.com/qrealka/0aa39d850310d02ced2dd71a95ae6b0f)

- [Linux guide](https://gist.github.com/kennwhite/b05fcdd2161688c1e859f962ec90c4f4)

- [Windows guide](https://sinclairinat0r.com/2019/04/29/building-chromium-on-windows-from-source)

- [Android guide](https://andreasch.com/2019/01/29/build-chromium-android/)
